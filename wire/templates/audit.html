<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EDROWIRE — ALGO AUDIT</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" media="print" onload="this.media='all'">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    background: #0a0a0a;
    color: #cccccc;
    font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.35;
    -webkit-font-smoothing: antialiased;
}

#app {
    max-width: 960px;
    margin: 0 auto;
    padding: 16px 20px 100px;
}

header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 20px;
    border-bottom: 1px solid #222;
    padding-bottom: 12px;
}

.logo {
    font-size: 24px;
    font-weight: 700;
    color: #ffb000;
    letter-spacing: 4px;
    text-decoration: none;
}

.subtitle {
    font-size: 14px;
    color: #666;
    letter-spacing: 2px;
}

.back-link {
    margin-left: auto;
    color: #555;
    text-decoration: none;
    font-size: 12px;
}
.back-link:hover { color: #ffb000; }

/* Menu grid */
.menu-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    margin-top: 20px;
}

.menu-card {
    background: #111;
    border: 1px solid #222;
    padding: 24px 20px;
    cursor: pointer;
    transition: border-color 0.15s, background 0.15s;
}
.menu-card:hover {
    border-color: #ffb000;
    background: #141410;
}

.menu-card .mc-title {
    font-size: 15px;
    font-weight: 700;
    color: #ffb000;
    letter-spacing: 2px;
    margin-bottom: 8px;
}

.menu-card .mc-desc {
    color: #888;
    font-size: 12px;
    margin-bottom: 12px;
    line-height: 1.5;
}

.menu-card .mc-count {
    color: #555;
    font-size: 11px;
    letter-spacing: 1px;
}

/* Audit view header */
.audit-header {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 20px;
}

.back-btn {
    background: none;
    border: 1px solid #333;
    color: #888;
    font-family: inherit;
    font-size: 16px;
    padding: 4px 10px;
    cursor: pointer;
    transition: all 0.15s;
    line-height: 1;
}
.back-btn:hover { border-color: #ffb000; color: #ffb000; }

.audit-title {
    font-size: 16px;
    font-weight: 700;
    color: #ffb000;
    letter-spacing: 2px;
}

.audit-count {
    color: #555;
    font-size: 12px;
    margin-left: auto;
    letter-spacing: 1px;
}

/* Cards */
.audit-card {
    background: #111;
    border: 1px solid #222;
    padding: 14px 16px;
    margin-bottom: 12px;
}

.audit-card .headline {
    color: #ffb000;
    font-weight: 700;
    font-size: 14px;
    margin-bottom: 6px;
}

.audit-card .meta {
    color: #555;
    font-size: 11px;
    margin-bottom: 10px;
}

.audit-card .meta span {
    margin-right: 12px;
}

.source-tag { color: #4a9e4a; }
.category-tag { color: #888; text-transform: uppercase; letter-spacing: 1px; }

/* Sources list */
.sources-list {
    margin: 8px 0;
    padding-left: 16px;
    font-size: 11px;
    color: #666;
}
.sources-list li { margin-bottom: 2px; }

/* Raw items in cluster */
.raw-items {
    margin-top: 10px;
    border-top: 1px solid #1a1a1a;
    padding-top: 8px;
}

.raw-item {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    margin-bottom: 6px;
    font-size: 12px;
}

.raw-item .ri-headline { color: #999; flex: 1; }
.raw-item .ri-source { color: #4a9e4a; font-size: 11px; white-space: nowrap; }

/* Rating controls */
.rating-row {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-top: 10px;
    flex-wrap: wrap;
}

.stars { display: flex; gap: 4px; }

.star {
    cursor: pointer;
    font-size: 18px;
    color: #333;
    transition: color 0.15s;
    user-select: none;
}
.star.filled { color: #ffb000; }
.star:hover { color: #ffb000; }

.flag-btns { display: flex; gap: 4px; }

.flag-btn {
    background: #1a1a1a;
    border: 1px solid #333;
    color: #888;
    padding: 3px 10px;
    font-family: inherit;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.15s;
}
.flag-btn:hover { border-color: #ffb000; color: #ffb000; }
.flag-btn.selected {
    background: #ffb000;
    color: #0a0a0a;
    border-color: #ffb000;
}

/* Checkbox */
.doesnt-belong {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: #888;
    cursor: pointer;
}
.doesnt-belong input { accent-color: #ffb000; }

/* Category controls */
.cat-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 10px;
}

.cat-label {
    color: #888;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 12px;
    min-width: 80px;
}

select {
    background: #111;
    border: 1px solid #333;
    color: #ccc;
    font-family: inherit;
    font-size: 12px;
    padding: 4px 8px;
}
select:focus { border-color: #ffb000; outline: none; }

/* Headline comparison */
.headline-pair {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 6px;
}

.hl-label {
    font-size: 10px;
    color: #555;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 4px;
}

.hl-original { color: #888; font-size: 12px; }
.hl-rewritten { color: #ffb000; font-size: 13px; font-weight: 700; }

/* Source tiers */
.tier-section { margin-bottom: 16px; }

.tier-header {
    color: #ffb000;
    font-weight: 700;
    font-size: 13px;
    margin-bottom: 8px;
    letter-spacing: 1px;
}

.tier-source {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 4px 0;
    font-size: 12px;
}

.tier-source .ts-name { color: #ccc; min-width: 180px; }

/* Notes textarea */
.notes-section {
    margin-top: 24px;
    border-top: 1px solid #222;
    padding-top: 16px;
}

.notes-section .notes-label {
    font-size: 11px;
    color: #555;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
}

textarea {
    background: #111;
    border: 1px solid #333;
    color: #ccc;
    font-family: inherit;
    font-size: 13px;
    padding: 12px;
    width: 100%;
    min-height: 100px;
    resize: vertical;
}
textarea:focus { border-color: #ffb000; outline: none; }
textarea::placeholder { color: #444; }

/* Bottom bar */
.bottom-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #0a0a0a;
    border-top: 1px solid #222;
    padding: 12px 20px;
    display: flex;
    justify-content: center;
    gap: 12px;
    z-index: 100;
}

.dl-btn {
    background: #ffb000;
    color: #0a0a0a;
    border: 1px solid #ffb000;
    font-family: inherit;
    font-size: 13px;
    font-weight: 700;
    padding: 8px 32px;
    cursor: pointer;
    letter-spacing: 2px;
    transition: all 0.15s;
}
.dl-btn:hover { background: #e6a000; }

/* Loading */
.loading {
    text-align: center;
    color: #555;
    padding: 60px 0;
    font-size: 14px;
    letter-spacing: 2px;
}

@media (max-width: 600px) {
    .menu-grid { grid-template-columns: 1fr; }
    .headline-pair { grid-template-columns: 1fr; }
    .rating-row { gap: 10px; }
    .tier-source .ts-name { min-width: 120px; }
}
</style>
</head>
<body>
<div id="app">
    <header>
        <a href="/" class="logo">EDROWIRE</a>
        <span class="subtitle">ALGO AUDIT</span>
        <a href="/" class="back-link">back to wire</a>
    </header>
    <div id="content"></div>
</div>

<div class="bottom-bar" id="bottomBar" style="display:none">
    <button class="dl-btn" onclick="downloadCSV()">DOWNLOAD CSV</button>
</div>

<script>
const CATEGORIES = ['tech', 'markets', 'politics', 'world', 'general'];
const AUDIT_MODES = {
    ranking:    { title: 'TOP RANKING',        desc: 'Rate the current top stories. Do they deserve their positions?', count: 20 },
    clustering: { title: 'CLUSTERING QUALITY', desc: 'Are the biggest clusters grouping the same story correctly?',    count: 15 },
    categories: { title: 'CATEGORY ACCURACY',  desc: 'Check auto-assigned categories on random recent stories.',       count: 40 },
    headlines:  { title: 'HEADLINE QUALITY',   desc: 'Rate the quality of rewritten headlines vs their originals.',    count: 30 },
    sources:    { title: 'SOURCE TIERS',       desc: 'Review source quality tier assignments from the active algo.',   count: 'all' },
};

// Per-mode response stores, persist across navigation within a session
const allResponses = { ranking: [], clustering: [], categories: [], headlines: [], sources: [] };
const notesStore = { ranking: '', clustering: '', categories: '', headlines: '', sources: '' };
let currentMode = null;
let currentData = null;

function esc(s) {
    if (!s) return '';
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
}

function timeAgo(iso) {
    if (!iso) return '';
    const diff = (Date.now() - new Date(iso).getTime()) / 1000;
    if (diff < 60) return 'just now';
    if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
    if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
    return Math.floor(diff / 86400) + 'd ago';
}

function addResponse(mode, item_id, headline, field, value) {
    const responses = allResponses[mode];
    const idx = responses.findIndex(r => r.item_id === item_id && r.field === field);
    if (idx >= 0) responses.splice(idx, 1);
    responses.push({ mode, item_id, headline, field, value });
}

function getResponse(mode, item_id, field) {
    return allResponses[mode].find(r => r.item_id === item_id && r.field === field);
}

// Stars
function starsHTML(mode, id, headline, field) {
    const existing = getResponse(mode, id, field);
    const val = existing ? parseInt(existing.value) : 0;
    let h = '<div class="stars">';
    for (let i = 1; i <= 5; i++) {
        h += `<span class="star ${i <= val ? 'filled' : ''}" data-mode="${mode}" data-id="${id}" data-headline="${encodeURIComponent(headline)}" data-field="${field}" data-val="${i}" onclick="rateStar(this)">&#9733;</span>`;
    }
    h += '</div>';
    return h;
}

function rateStar(el) {
    const { mode, id, headline, field } = el.dataset;
    const val = parseInt(el.dataset.val);
    addResponse(mode, id, decodeURIComponent(headline), field, String(val));
    el.parentElement.querySelectorAll('.star').forEach(s => {
        s.classList.toggle('filled', parseInt(s.dataset.val) <= val);
    });
}

function flagClick(el) {
    const { mode, id, headline, field, val } = el.dataset;
    addResponse(mode, id, decodeURIComponent(headline), field, val);
    el.parentElement.querySelectorAll('.flag-btn').forEach(b => {
        b.classList.toggle('selected', b.dataset.val === val);
    });
}

function toggleBelong(el, clusterId, itemUrl, itemHeadline) {
    const id = clusterId + ':' + decodeURIComponent(itemUrl);
    const headline = decodeURIComponent(itemHeadline);
    if (el.checked) {
        addResponse('clustering', id, headline, 'belongs', 'no');
    } else {
        const responses = allResponses['clustering'];
        const idx = responses.findIndex(r => r.item_id === id && r.field === 'belongs');
        if (idx >= 0) responses.splice(idx, 1);
    }
}

// --- Views ---

function showMenu() {
    currentMode = null;
    document.getElementById('bottomBar').style.display = 'none';
    let h = '<div class="menu-grid">';
    for (const [mode, info] of Object.entries(AUDIT_MODES)) {
        const n = allResponses[mode].length;
        const badge = n > 0 ? ` <span style="color:#4a9e4a">(${n} rated)</span>` : '';
        h += `<div class="menu-card" onclick="enterAudit('${mode}')">
            <div class="mc-title">${info.title}</div>
            <div class="mc-desc">${info.desc}</div>
            <div class="mc-count">${info.count} items${badge}</div>
        </div>`;
    }
    h += '</div>';
    document.getElementById('content').innerHTML = h;
    window.scrollTo(0, 0);
}

async function enterAudit(mode) {
    currentMode = mode;
    const info = AUDIT_MODES[mode];
    document.getElementById('content').innerHTML = `
        <div class="audit-header">
            <button class="back-btn" onclick="showMenu()">&larr;</button>
            <div class="audit-title">${info.title}</div>
            <div class="audit-count">loading...</div>
        </div>
        <div class="loading">LOADING...</div>`;
    document.getElementById('bottomBar').style.display = 'flex';

    try {
        const res = await fetch('/api/audit/data?mode=' + mode);
        if (!res.ok) throw new Error('Failed to load');
        currentData = await res.json();
        renderAudit(mode);
    } catch (e) {
        document.getElementById('content').innerHTML = `
            <div class="audit-header">
                <button class="back-btn" onclick="showMenu()">&larr;</button>
                <div class="audit-title">${info.title}</div>
            </div>
            <div class="loading">ERROR: ${esc(e.message)}</div>`;
    }
}

function renderAudit(mode) {
    const info = AUDIT_MODES[mode];
    const items = currentData.items;
    const count = mode === 'sources' ? Object.values(items).reduce((a, b) => a + b.length, 0) : items.length;
    let h = `<div class="audit-header">
        <button class="back-btn" onclick="showMenu()">&larr;</button>
        <div class="audit-title">${info.title}</div>
        <div class="audit-count">${count} ITEMS &middot; ${esc(currentData.algo_version)}</div>
    </div>`;

    const renderers = { ranking: renderRanking, clustering: renderClustering, categories: renderCategories, headlines: renderHeadlines, sources: renderSources };
    h += renderers[mode](items);

    // Notes field
    h += `<div class="notes-section">
        <div class="notes-label">NOTES</div>
        <textarea placeholder="Free-text observations about this audit..." oninput="notesStore['${mode}']=this.value">${esc(notesStore[mode])}</textarea>
    </div>`;

    document.getElementById('content').innerHTML = h;
    window.scrollTo(0, 0);
}

function renderRanking(items) {
    let h = '';
    items.forEach((s, i) => {
        const allSources = (s.other_sources || []).map(o => o.name);
        allSources.unshift(s.source);
        h += `<div class="audit-card">
            <div class="headline">#${i + 1} &mdash; ${esc(s.headline)}</div>
            <div class="meta">
                <span class="source-tag">${esc(s.source)}</span>
                <span>${s.source_count} sources</span>
                <span>${timeAgo(s.published_at)}</span>
                <span class="category-tag">${esc(s.category)}</span>
            </div>
            <ul class="sources-list">${allSources.map(n => `<li>${esc(n)}</li>`).join('')}</ul>
            <div class="rating-row">
                ${starsHTML('ranking', s.id, s.headline, 'position_rating')}
                <div class="flag-btns">
                    ${['too_high', 'about_right', 'too_low'].map(v => {
                        const existing = getResponse('ranking', s.id, 'position_flag');
                        const sel = existing && existing.value === v ? 'selected' : '';
                        return `<button class="flag-btn ${sel}" data-mode="ranking" data-id="${s.id}" data-headline="${encodeURIComponent(s.headline)}" data-field="position_flag" data-val="${v}" onclick="flagClick(this)">${v.replace(/_/g, ' ')}</button>`;
                    }).join('')}
                </div>
            </div>
        </div>`;
    });
    return h || '<div class="loading">No stories available</div>';
}

function renderClustering(items) {
    let h = '';
    items.forEach(c => {
        const rawItems = c.items || [];
        h += `<div class="audit-card">
            <div class="headline">${esc(c.headline)} <span style="color:#555;font-weight:400;font-size:12px">(${c.source_count} sources)</span></div>
            <div class="raw-items">
                ${rawItems.map(it => {
                    const checked = getResponse('clustering', c.id + ':' + it.url, 'belongs') ? 'checked' : '';
                    return `<div class="raw-item">
                        <label class="doesnt-belong">
                            <input type="checkbox" ${checked} onchange="toggleBelong(this, '${c.id}', '${encodeURIComponent(it.url)}', '${encodeURIComponent(it.headline)}')">
                        </label>
                        <span class="ri-headline">${esc(it.headline)}</span>
                        <span class="ri-source">${esc(it.source)}</span>
                    </div>`;
                }).join('')}
            </div>
            <div class="rating-row">
                ${starsHTML('clustering', c.id, c.headline, 'cluster_rating')}
                <span style="font-size:11px;color:#555">Check items that don't belong</span>
            </div>
        </div>`;
    });
    return h || '<div class="loading">No clusters available</div>';
}

function renderCategories(items) {
    let h = '';
    items.forEach(s => {
        const existingCorrect = getResponse('categories', s.id, 'category_correct');
        const existingCat = getResponse('categories', s.id, 'correct_category');
        h += `<div class="audit-card">
            <div class="headline">${esc(s.headline)}</div>
            <div class="meta"><span class="source-tag">${esc(s.source)}</span> <span>${timeAgo(s.published_at)}</span></div>
            <div class="cat-row">
                <span class="cat-label">${esc(s.category)}</span>
                <div class="flag-btns">
                    <button class="flag-btn ${existingCorrect && existingCorrect.value === 'yes' ? 'selected' : ''}" data-mode="categories" data-id="${s.id}" data-headline="${encodeURIComponent(s.headline)}" data-field="category_correct" data-val="yes" onclick="flagClick(this)">correct</button>
                    <button class="flag-btn ${existingCorrect && existingCorrect.value === 'no' ? 'selected' : ''}" data-mode="categories" data-id="${s.id}" data-headline="${encodeURIComponent(s.headline)}" data-field="category_correct" data-val="no" onclick="flagClick(this)">wrong</button>
                </div>
                <select onchange="addResponse('categories','${s.id}','${encodeURIComponent(s.headline)}','correct_category',this.value)">
                    <option value="">right category...</option>
                    ${CATEGORIES.map(c => `<option value="${c}" ${existingCat && existingCat.value === c ? 'selected' : ''}>${c.toUpperCase()}</option>`).join('')}
                </select>
            </div>
        </div>`;
    });
    return h || '<div class="loading">No stories available</div>';
}

function renderHeadlines(items) {
    let h = '';
    items.forEach(s => {
        h += `<div class="audit-card">
            <div class="headline-pair">
                <div><div class="hl-label">Original</div><div class="hl-original">${esc(s.original_headline)}</div></div>
                <div><div class="hl-label">Rewritten</div><div class="hl-rewritten">${esc(s.headline)}</div></div>
            </div>
            <div class="meta"><span class="source-tag">${esc(s.source)}</span></div>
            <div class="rating-row">
                ${starsHTML('headlines', s.id, s.headline, 'headline_rating')}
                <span style="font-size:11px;color:#555">Accurate and clear?</span>
            </div>
        </div>`;
    });
    return h || '<div class="loading">No headline samples available</div>';
}

function renderSources(tiers) {
    const tierLabels = { '3.0': 'TIER 1 — Wire Services (3.0x)', '2.5': 'TIER 2 — Major Outlets (2.5x)', '2.0': 'TIER 3 — Specialist (2.0x)', '1.5': 'TIER 4 — Trade Press (1.5x)', '1.0': 'TIER 5 — Niche (1.0x)', '0.6': 'TIER 6 — Aggregators (0.6x)' };
    let h = '';
    for (const [mult, sources] of Object.entries(tiers)) {
        h += `<div class="tier-section">
            <div class="tier-header">${tierLabels[mult] || 'TIER ' + mult}</div>
            ${sources.map(name => {
                const existing = getResponse('sources', name, 'tier_flag');
                return `<div class="tier-source">
                    <span class="ts-name">${esc(name)}</span>
                    <div class="flag-btns">
                        ${['move_up', 'correct', 'move_down'].map(v => {
                            const sel = existing && existing.value === v ? 'selected' : '';
                            return `<button class="flag-btn ${sel}" data-mode="sources" data-id="${name}" data-headline="" data-field="tier_flag" data-val="${v}" onclick="flagClick(this)">${v.replace(/_/g, ' ')}</button>`;
                        }).join('')}
                    </div>
                </div>`;
            }).join('')}
        </div>`;
    }
    return h || '<div class="loading">No tier data available</div>';
}

// CSV export
function downloadCSV() {
    const csvEsc = s => {
        if (!s) return '';
        s = String(s);
        if (s.includes(',') || s.includes('"') || s.includes('\n')) {
            return '"' + s.replace(/"/g, '""') + '"';
        }
        return s;
    };
    let rows = ['mode,item_id,headline,field,value'];
    for (const [mode, responses] of Object.entries(allResponses)) {
        for (const r of responses) {
            rows.push([r.mode, r.item_id, r.headline, r.field, r.value].map(csvEsc).join(','));
        }
        if (notesStore[mode]) {
            rows.push([mode, '', '', 'notes', notesStore[mode]].map(csvEsc).join(','));
        }
    }
    const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `edrowire-audit-${new Date().toISOString().slice(0, 10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}

// Init
showMenu();
</script>
</body>
</html>
