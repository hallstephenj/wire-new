<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DINWIRE / CONTROL PANEL</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" media="print" onload="this.media='all'">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    background: #0a0a0a;
    color: #cccccc;
    font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
    font-size: 12px;
    line-height: 1.4;
    -webkit-font-smoothing: antialiased;
}

a { color: #ffb000; text-decoration: none; }
a:hover { text-decoration: underline; }

/* â”€â”€ Top Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 16px;
    border-bottom: 1px solid #222;
}

.logo { font-size: 20px; font-weight: 700; color: #ffb000; letter-spacing: 4px; }
.logo-sub { color: #555; font-size: 12px; letter-spacing: 2px; margin-left: 8px; }
.back { color: #555; font-size: 11px; }

.action-btn {
    padding: 4px 10px;
    cursor: pointer;
    color: #ffb000;
    border: 1px solid #ffb000;
    background: transparent;
    font-family: inherit;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
}
.action-btn:hover { background: #1a1400; }
.action-btn:disabled { color: #555; border-color: #333; cursor: default; background: transparent; }
.action-btn.danger { color: #e04040; border-color: #e04040; }
.action-btn.danger:hover { background: #1a0000; }

/* â”€â”€ Primary Tab Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.primary-tabs {
    display: flex;
    align-items: center;
    gap: 0;
    border-bottom: 1px solid #222;
    background: #0d0d0d;
}

.primary-tab {
    padding: 8px 20px;
    cursor: pointer;
    color: #555;
    border: none;
    border-bottom: 2px solid transparent;
    background: transparent;
    font-family: inherit;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2px;
}

.primary-tab:hover { color: #999; }
.primary-tab.active { color: #ffb000; border-bottom-color: #ffb000; }

.primary-tab .tab-badge {
    font-size: 9px;
    color: #555;
    margin-left: 6px;
    font-weight: 400;
}

.primary-tab.active .tab-badge { color: #886000; }

/* â”€â”€ Tab Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tab-content {
    display: none;
    height: calc(100vh - 90px);
    overflow: hidden;
}

.tab-content.active { display: flex; }

/* â”€â”€ Shared â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tabs {
    display: flex;
    gap: 2px;
}

.tab {
    padding: 4px 10px;
    cursor: pointer;
    color: #555;
    border: 1px solid #222;
    background: transparent;
    font-family: inherit;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.tab:hover { color: #999; border-color: #444; }
.tab.active { color: #ffb000; border-color: #ffb000; background: rgba(255,176,0,0.05); }

.separator { color: #333; margin: 0 4px; }

.panel {
    border-bottom: 1px solid #1a1a1a;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.panel-grow { flex: 1; }

.panel-header {
    padding: 8px 12px;
    background: #0f0f0f;
    border-bottom: 1px solid #1a1a1a;
    font-size: 10px;
    font-weight: 700;
    color: #555;
    letter-spacing: 2px;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
}

.panel-body {
    padding: 10px 12px;
    overflow-y: auto;
    flex: 1;
}

.pagination {
    display: flex;
    justify-content: center;
    gap: 8px;
    padding: 8px;
    border-top: 1px solid #1a1a1a;
    flex-shrink: 0;
}

.pagination button {
    padding: 3px 10px;
    cursor: pointer;
    color: #888;
    border: 1px solid #333;
    background: transparent;
    font-family: inherit;
    font-size: 10px;
}

.pagination button:hover { color: #ccc; border-color: #555; }
.pagination button:disabled { color: #333; cursor: default; }
.pagination span { color: #555; font-size: 10px; line-height: 24px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 1: STORIES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stories-layout {
    display: grid;
    grid-template-columns: 1fr 300px;
    width: 100%;
    overflow: hidden;
}

.stories-main {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border-right: 1px solid #1a1a1a;
}

.stories-sidebar {
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.stories-toolbar {
    display: flex;
    gap: 8px;
    align-items: center;
    padding: 8px 12px;
    background: #0f0f0f;
    border-bottom: 1px solid #1a1a1a;
    flex-shrink: 0;
    flex-wrap: wrap;
}

.show-hidden-label {
    color: #666;
    font-size: 10px;
    display: flex;
    align-items: center;
    gap: 4px;
    cursor: pointer;
    margin-left: auto;
}

.show-hidden-label input[type="checkbox"] { accent-color: #ffb000; }

/* â”€â”€ Electric ball â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.wire-ball {
    --energy: 0;
    --size: calc(6px + var(--energy) * 10px);
    --glow: calc(var(--energy) * 25px);
    --glow2: calc(var(--energy) * 50px);
    --glow3: calc(var(--energy) * 80px);
    --bright: calc(0.08 + var(--energy) * 0.92);
    width: var(--size);
    height: var(--size);
    min-width: 6px;
    min-height: 6px;
    border-radius: 50%;
    margin-top: 3px;
    flex-shrink: 0;
    background: radial-gradient(circle at 30% 30%,
        hsla(40, 100%, 95%, var(--bright)),
        hsla(30, 100%, 65%, var(--bright)),
        hsla(22, 100%, 50%, calc(var(--bright) * 0.7)),
        hsla(15, 100%, 30%, calc(var(--bright) * 0.3))
    );
    box-shadow:
        0 0 calc(var(--energy) * 3px) hsla(30, 100%, 80%, var(--bright)),
        0 0 var(--glow) hsla(25, 100%, 55%, calc(var(--bright) * 0.9)),
        0 0 var(--glow2) hsla(20, 100%, 45%, calc(var(--bright) * 0.5)),
        0 0 var(--glow3) hsla(15, 100%, 35%, calc(var(--bright) * 0.2));
    animation:
        wirePulse calc(2.5s - var(--energy) * 1s) ease-in-out infinite,
        wireCreepScale calc(4s - var(--energy) * 2s) ease-in-out infinite alternate;
    position: relative;
}

.wire-ball::after {
    content: '';
    position: absolute;
    inset: -3px;
    border-radius: 50%;
    background: transparent;
    box-shadow: 0 0 calc(var(--energy) * 12px) hsla(25, 100%, 65%, calc(var(--energy) * 0.5));
    animation: wireGlow calc(3s - var(--energy) * 1.5s) ease-in-out infinite alternate;
}

@keyframes wirePulse {
    0% { opacity: 0.85; filter: brightness(1); }
    50% { opacity: 1; filter: brightness(1.1); }
    100% { opacity: 0.85; filter: brightness(1); }
}

@keyframes wireCreepScale {
    0% { transform: scale(1); }
    100% { transform: scale(calc(1 + var(--energy) * 0.2)); }
}

@keyframes wireGlow {
    0% { opacity: 0.4; }
    100% { opacity: 1; }
}

/* â”€â”€ Story List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.story-list {
    list-style: none;
    overflow-y: auto;
    flex: 1;
}

.story-row {
    padding: 8px 12px;
    border-bottom: 1px solid #111;
    cursor: default;
    border-left: 3px solid transparent;
    display: flex;
    gap: 10px;
    align-items: flex-start;
}

.story-row-body { flex: 1; min-width: 0; }

.story-row:hover { background: #0d0d0d; }
.story-row.pinned { border-left-color: #ffb000; }
.story-row.hidden { opacity: 0.4; }
.story-row.hidden .story-headline { text-decoration: line-through; }
.story-row.breaking { border-left-color: #e04040; background: rgba(224,64,64,0.03); }
.story-row.breaking .story-headline { color: #ff6060; }
.story-row.locked .story-headline::after { content: ' ğŸ”’'; font-size: 10px; }
.story-row.boosted { border-left-color: #4a9e4a; }
.story-row.demoted { opacity: 0.5; }

@keyframes breakingFlash {
    0%, 100% { border-left-color: #e04040; }
    50% { border-left-color: #ff4040; }
}

.story-row.breaking { animation: breakingFlash 2s ease-in-out infinite; }

.story-main {
    display: flex;
    align-items: baseline;
    gap: 8px;
    flex-wrap: wrap;
}

.story-headline {
    color: #ffb000;
    font-size: 12px;
    cursor: text;
    line-height: 1.4;
    text-decoration: none;
}

.story-headline:hover { text-decoration: underline; }

.story-meta {
    display: flex;
    gap: 8px;
    align-items: center;
    font-size: 11px;
    white-space: nowrap;
}

.story-source { color: #4a9e4a; }
.story-count { color: #4a9e4a; }

.story-also {
    font-size: 11px;
    color: #444;
    padding-left: 0;
    margin-top: 1px;
}

.story-also a { color: #555; text-decoration: none; }
.story-also a:hover { color: #888; text-decoration: underline; }

.story-category {
    font-size: 9px;
    color: #888;
    letter-spacing: 1px;
    text-transform: uppercase;
    cursor: pointer;
    padding: 1px 5px;
    border: 1px solid #222;
}

.story-category:hover { border-color: #555; color: #ccc; }

.story-time {
    font-size: 10px;
    color: #3a3a3a;
}

/* â”€â”€ Curation Icon Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.curation-bar {
    display: flex;
    gap: 3px;
    align-items: center;
    margin-top: 4px;
    flex-wrap: wrap;
}

.cur-btn {
    padding: 2px 6px;
    cursor: pointer;
    color: #555;
    border: 1px solid #222;
    background: transparent;
    font-family: inherit;
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 1px;
    white-space: nowrap;
}

.cur-btn:hover { color: #ccc; border-color: #555; }
.cur-btn.active { color: #ffb000; border-color: #ffb000; }
.cur-btn.breaking-active { color: #e04040; border-color: #e04040; }
.cur-btn.kill-btn:hover { color: #e04040; border-color: #e04040; }
.cur-btn.boost-active { color: #4a9e4a; border-color: #4a9e4a; }
.cur-btn.demote-active { color: #e04040; border-color: #e04040; }
.cur-btn.note-active { color: #c06ece; border-color: #c06ece; }

/* â”€â”€ Expanded Story View â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.story-expanded {
    display: none;
    margin-top: 8px;
    padding: 8px;
    background: #0d0d0d;
    border: 1px solid #1a1a1a;
}

.story-expanded.open { display: block; }

.note-display {
    padding: 4px 8px;
    margin-bottom: 6px;
    background: rgba(192,110,206,0.08);
    border-left: 2px solid #c06ece;
    color: #c06ece;
    font-size: 10px;
    word-break: break-word;
}

.item-row {
    display: flex;
    gap: 8px;
    align-items: center;
    padding: 4px 0;
    border-bottom: 1px solid #111;
    font-size: 10px;
}

.item-row label {
    display: flex;
    align-items: center;
    gap: 6px;
    flex: 1;
    color: #888;
    cursor: pointer;
}

.item-row input[type="checkbox"] { accent-color: #ffb000; }
.item-source { color: #555; font-size: 9px; min-width: 80px; }

.swap-btn {
    padding: 1px 5px;
    cursor: pointer;
    color: #555;
    border: 1px solid #222;
    background: transparent;
    font-family: inherit;
    font-size: 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.swap-btn:hover { color: #ffb000; border-color: #ffb000; }

.merge-bar, .split-bar {
    display: flex;
    gap: 6px;
    align-items: center;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #1a1a1a;
}

.merge-bar input {
    background: #111;
    border: 1px solid #333;
    color: #ccc;
    font-family: inherit;
    font-size: 10px;
    padding: 3px 6px;
    flex: 1;
}

/* â”€â”€ Curation Log (stories sidebar) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.log-entry {
    padding: 6px 0;
    border-bottom: 1px solid #111;
    font-size: 10px;
}

.log-action {
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    font-size: 9px;
}

.log-action.edit_headline, .log-action.edit_category { color: #ce8e4a; }
.log-action.pin, .log-action.unpin { color: #ffb000; }
.log-action.hide, .log-action.unhide { color: #666; }
.log-action.merge, .log-action.split { color: #5a9ece; }
.log-action.config_change { color: #c06ece; }
.log-action.lock, .log-action.unlock { color: #e04040; }
.log-action.breaking_on, .log-action.breaking_off { color: #ff4040; }
.log-action.kill, .log-action.not_news { color: #e04040; }
.log-action.boost { color: #4a9e4a; }
.log-action.demote, .log-action.unboost { color: #ce8e4a; }
.log-action.note { color: #c06ece; }
.log-action.set_expiry { color: #5a9ece; }
.log-action.swap_primary { color: #ffb000; }
.log-action.flag_miscategorized, .log-action.flag_bad_headline,
.log-action.flag_bad_merge, .log-action.flag_duplicate,
.log-action.flag_stale { color: #e08040; }

.log-time { color: #444; font-size: 9px; }
.log-detail { color: #666; font-size: 10px; word-break: break-word; }
.log-cluster { color: #555; font-size: 9px; }

/* â”€â”€ Inline edit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.inline-edit {
    background: #111;
    border: 1px solid #ffb000;
    color: #fff;
    font-family: inherit;
    font-size: 12px;
    padding: 4px 6px;
    width: 100%;
}

/* â”€â”€ Category dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cat-dropdown {
    position: absolute;
    background: #111;
    border: 1px solid #333;
    z-index: 100;
    list-style: none;
}

.cat-dropdown li {
    padding: 4px 12px;
    cursor: pointer;
    font-size: 10px;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.cat-dropdown li:hover { background: #1a1400; color: #ffb000; }

/* â”€â”€ Flag dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.flag-dropdown {
    position: fixed;
    background: #111;
    border: 1px solid #333;
    z-index: 100;
    list-style: none;
}

.flag-dropdown li {
    padding: 4px 12px;
    cursor: pointer;
    font-size: 10px;
    color: #e08040;
    letter-spacing: 1px;
}

.flag-dropdown li:hover { background: #1a0a00; color: #ffb000; }

/* â”€â”€ Note input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.note-input-bar {
    display: flex;
    gap: 4px;
    margin-top: 6px;
    padding-top: 6px;
    border-top: 1px solid #1a1a1a;
}

.note-input-bar input {
    background: #111;
    border: 1px solid #333;
    color: #ccc;
    font-family: inherit;
    font-size: 10px;
    padding: 3px 6px;
    flex: 1;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 2: FILTERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.filters-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    width: 100%;
    overflow: hidden;
}

.filters-patterns-pane, .filters-log-pane {
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.filters-patterns-pane {
    border-right: 1px solid #1a1a1a;
}

.filter-row {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 5px 0;
    border-bottom: 1px solid #111;
    font-size: 10px;
}

.filter-row.disabled { opacity: 0.4; }

.filter-name { flex: 1; color: #ccc; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

.filter-type-badge {
    font-size: 8px;
    padding: 1px 4px;
    letter-spacing: 1px;
    font-weight: 700;
    color: #ce8e4a;
    border: 1px solid #6e4a2a;
    white-space: nowrap;
}

.filter-toggle {
    padding: 2px 6px;
    cursor: pointer;
    border: 1px solid #222;
    background: transparent;
    font-family: inherit;
    font-size: 8px;
    font-weight: 700;
    letter-spacing: 1px;
}

.filter-toggle.on { color: #4a9e4a; border-color: #2a5a2a; }
.filter-toggle.off { color: #e04040; border-color: #6e2a2a; }

.filter-del {
    padding: 2px 5px;
    cursor: pointer;
    color: #555;
    border: 1px solid #222;
    background: transparent;
    font-family: inherit;
    font-size: 8px;
}

.filter-del:hover { color: #e04040; border-color: #e04040; }

.filter-add-form {
    padding: 8px 0;
    border-top: 1px solid #1a1a1a;
    margin-top: 6px;
}

.filter-add-form input, .filter-add-form select {
    background: #111;
    border: 1px solid #333;
    color: #ccc;
    font-family: inherit;
    font-size: 10px;
    padding: 3px 6px;
    width: 100%;
    margin-bottom: 4px;
}

.filter-add-form select { width: 100%; }

.filter-add-buttons {
    display: flex;
    gap: 4px;
    margin-top: 4px;
}

.filter-test-results {
    max-height: 200px;
    overflow-y: auto;
    font-size: 9px;
    color: #888;
    margin-top: 4px;
    border: 1px solid #1a1a1a;
    padding: 4px;
}

.filter-test-results div {
    padding: 2px 0;
    border-bottom: 1px solid #111;
}

.filtered-item-row {
    padding: 5px 0;
    border-bottom: 1px solid #111;
    font-size: 10px;
}

.filtered-item-headline { color: #888; word-break: break-word; }
.filtered-item-meta { color: #555; font-size: 9px; margin-top: 2px; }
.filtered-item-filter { color: #ce8e4a; font-size: 9px; }

.filter-search-input {
    background: #111;
    border: 1px solid #333;
    color: #ccc;
    font-family: inherit;
    font-size: 10px;
    padding: 3px 6px;
    width: 100%;
    margin-bottom: 6px;
}

.filter-search-input:focus { border-color: #ffb000; outline: none; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 3: REFERENCES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.references-layout {
    display: grid;
    grid-template-columns: 300px 1fr 1fr;
    width: 100%;
    overflow: hidden;
}

.references-sites-pane, .references-gaps-pane, .references-log-pane {
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.references-sites-pane, .references-gaps-pane {
    border-right: 1px solid #1a1a1a;
}

.ref-site-row {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 0;
    border-bottom: 1px solid #111;
    font-size: 10px;
}

.ref-site-row.disabled { opacity: 0.4; }

.ref-site-name { color: #ccc; font-weight: 700; min-width: 100px; }
.ref-site-url { flex: 1; color: #555; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 9px; }

.ref-site-stats {
    color: #888;
    font-size: 9px;
    white-space: nowrap;
}

.ref-site-stats .gaps { color: #e04040; }
.ref-site-stats .found { color: #4a9e4a; }

.ref-site-toggle {
    padding: 2px 6px;
    cursor: pointer;
    border: 1px solid #222;
    background: transparent;
    font-family: inherit;
    font-size: 8px;
    font-weight: 700;
    letter-spacing: 1px;
}

.ref-site-toggle.on { color: #4a9e4a; border-color: #2a5a2a; }
.ref-site-toggle.off { color: #e04040; border-color: #6e2a2a; }

.ref-site-del {
    padding: 2px 5px;
    cursor: pointer;
    color: #555;
    border: 1px solid #222;
    background: transparent;
    font-family: inherit;
    font-size: 8px;
}

.ref-site-del:hover { color: #e04040; border-color: #e04040; }

.ref-add-form {
    padding: 8px 0;
    border-top: 1px solid #1a1a1a;
    margin-top: 6px;
}

.ref-add-form input, .ref-add-form select {
    background: #111;
    border: 1px solid #333;
    color: #ccc;
    font-family: inherit;
    font-size: 10px;
    padding: 3px 6px;
    width: 100%;
    margin-bottom: 4px;
}

.ref-add-buttons {
    display: flex;
    gap: 4px;
    margin-top: 4px;
}

.ref-check-bar {
    padding: 8px 0;
    border-top: 1px solid #1a1a1a;
    margin-top: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.ref-check-status {
    color: #888;
    font-size: 9px;
}

.ref-log-entry {
    padding: 5px 0;
    border-bottom: 1px solid #111;
    font-size: 10px;
}

.ref-log-headline { color: #ccc; word-break: break-word; }
.ref-log-meta { color: #555; font-size: 9px; margin-top: 2px; }

.ref-log-status {
    display: inline-block;
    font-size: 8px;
    padding: 1px 4px;
    letter-spacing: 1px;
    font-weight: 700;
    border: 1px solid;
}

.ref-log-status.matched { color: #4a9e4a; border-color: #2a5a2a; }
.ref-log-status.gap_filled { color: #ffb000; border-color: #665500; }
.ref-log-status.gap_unfilled { color: #e04040; border-color: #6e2a2a; }
.ref-log-status.error { color: #e04040; border-color: #6e2a2a; }

.ref-gap-entry {
    padding: 6px 0;
    border-bottom: 1px solid #111;
    font-size: 10px;
}

.ref-gap-headline {
    color: #ccc;
    word-break: break-word;
    line-height: 1.4;
}

.ref-gap-meta {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 3px;
    font-size: 9px;
    color: #555;
}

.ref-gap-site {
    color: #888;
    font-weight: 700;
}

.ref-gap-result {
    font-size: 9px;
    color: #555;
    margin-top: 2px;
}

.ref-gap-result a {
    color: #ffb000;
    font-size: 9px;
}

.ref-gaps-empty {
    color: #333;
    font-size: 11px;
    padding: 20px 0;
    text-align: center;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 3: SYSTEM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.system-layout {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    width: 100%;
    overflow: hidden;
}

.system-col {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border-right: 1px solid #1a1a1a;
}

.system-col:last-child { border-right: none; }

/* â”€â”€ Processes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.job-card {
    border: 1px solid #1a1a1a;
    padding: 8px;
    background: #0d0d0d;
    margin-bottom: 6px;
}

.job-name {
    font-size: 10px;
    font-weight: 700;
    color: #ffb000;
    letter-spacing: 1px;
    margin-bottom: 4px;
}

.job-field {
    font-size: 10px;
    color: #666;
    margin-bottom: 2px;
}

.job-field span { color: #999; }

.job-countdown {
    font-size: 14px;
    font-weight: 700;
    color: #4a9e4a;
    margin-top: 2px;
}

/* â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stat-row {
    display: flex;
    justify-content: space-between;
    padding: 3px 0;
    font-size: 11px;
}

.stat-label { color: #666; }
.stat-value { color: #cccccc; font-weight: 700; }
.stat-value.amber { color: #ffb000; }
.stat-value.green { color: #4a9e4a; }

/* â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.filter-bar {
    display: flex;
    gap: 2px;
    flex-wrap: wrap;
}

.filter-btn {
    padding: 2px 6px;
    cursor: pointer;
    color: #555;
    border: 1px solid #222;
    background: transparent;
    font-family: inherit;
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.filter-btn:hover { color: #999; border-color: #444; }
.filter-btn.active { color: #ffb000; border-color: #ffb000; }

.event-list { list-style: none; }

.event-item {
    padding: 3px 0;
    border-bottom: 1px solid #111;
    font-size: 10px;
}

.ev-time { color: #444; font-size: 9px; }
.ev-tag {
    font-size: 8px;
    padding: 1px 4px;
    letter-spacing: 1px;
    font-weight: 700;
}

.ev-tag.ingest   { color: #4a9e4a; border: 1px solid #2a5a2a; }
.ev-tag.cluster  { color: #5a9ece; border: 1px solid #2a4a6e; }
.ev-tag.rewrite  { color: #ce8e4a; border: 1px solid #6e4a2a; }
.ev-tag.error    { color: #e04040; border: 1px solid #6e2a2a; }
.ev-tag.curation { color: #c06ece; border: 1px solid #6e2a6e; }

.ev-msg { color: #888; word-break: break-word; font-size: 10px; }

/* â”€â”€ Live Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.config-row {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 8px;
}

.config-label {
    font-size: 10px;
    color: #666;
    min-width: 100px;
}

.config-input {
    background: #111;
    border: 1px solid #333;
    color: #ccc;
    font-family: inherit;
    font-size: 11px;
    padding: 3px 6px;
    width: 100px;
}

.config-input:focus { border-color: #ffb000; outline: none; }

.config-set {
    padding: 3px 8px;
    cursor: pointer;
    color: #ffb000;
    border: 1px solid #ffb000;
    background: transparent;
    font-family: inherit;
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 1px;
}

.config-set:hover { background: #1a1400; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB: SOURCES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sources-layout {
    display: grid;
    grid-template-columns: 250px 1fr;
    width: 100%;
    overflow: hidden;
}

.sources-sidebar {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border-right: 1px solid #1a1a1a;
}

.sources-main {
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.sources-cat-btn {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    cursor: pointer;
    color: #888;
    border: none;
    border-bottom: 1px solid #111;
    background: transparent;
    font-family: inherit;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    width: 100%;
    text-align: left;
}

.sources-cat-btn:hover { color: #ccc; background: #111; }
.sources-cat-btn.active { color: #ffb000; background: #111; }

.sources-cat-badge {
    font-size: 9px;
    color: #555;
    font-weight: 400;
}

.sources-cat-btn.active .sources-cat-badge { color: #886000; }

.source-row {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 0;
    border-bottom: 1px solid #111;
    font-size: 10px;
}

.source-row.disabled { opacity: 0.4; }

.source-name { color: #ccc; font-weight: 700; min-width: 120px; }
.source-url { flex: 1; color: #555; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 9px; }
.source-cat-badge {
    font-size: 8px;
    padding: 1px 5px;
    letter-spacing: 1px;
    font-weight: 700;
    color: #888;
    border: 1px solid #333;
    white-space: nowrap;
}
.source-score {
    font-size: 9px;
    color: #888;
    min-width: 30px;
    text-align: right;
}

.source-toggle {
    padding: 2px 6px;
    cursor: pointer;
    border: 1px solid #222;
    background: transparent;
    font-family: inherit;
    font-size: 8px;
    font-weight: 700;
    letter-spacing: 1px;
}

.source-toggle.on { color: #4a9e4a; border-color: #2a5a2a; }
.source-toggle.off { color: #e04040; border-color: #6e2a2a; }

.source-del {
    padding: 2px 5px;
    cursor: pointer;
    color: #555;
    border: 1px solid #222;
    background: transparent;
    font-family: inherit;
    font-size: 8px;
}

.source-del:hover { color: #e04040; border-color: #e04040; }

.source-add-form {
    padding: 8px 0;
    border-top: 1px solid #1a1a1a;
    margin-top: 6px;
}

.source-add-form input, .source-add-form select {
    background: #111;
    border: 1px solid #333;
    color: #ccc;
    font-family: inherit;
    font-size: 10px;
    padding: 3px 6px;
    width: 100%;
    margin-bottom: 4px;
}

.source-add-buttons {
    display: flex;
    gap: 4px;
    margin-top: 4px;
}

.cat-add-form {
    padding: 8px 12px;
    border-top: 1px solid #1a1a1a;
    margin-top: auto;
    display: flex;
    gap: 4px;
}

.cat-add-form input {
    background: #111;
    border: 1px solid #333;
    color: #ccc;
    font-family: inherit;
    font-size: 10px;
    padding: 3px 6px;
    flex: 1;
}

/* â”€â”€ Category Management (System tab) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cat-mgmt-row {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 0;
    border-bottom: 1px solid #111;
    font-size: 10px;
}

.cat-mgmt-name { color: #ccc; font-weight: 700; flex: 1; }
.cat-mgmt-order { color: #555; font-size: 9px; }

/* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 1100px) {
    .stories-layout { grid-template-columns: 1fr; }
    .stories-sidebar { max-height: 300px; border-top: 1px solid #1a1a1a; }
    .filters-layout { grid-template-columns: 1fr; }
    .filters-log-pane { border-top: 1px solid #1a1a1a; }
    .references-layout { grid-template-columns: 1fr; }
    .references-sites-pane, .references-gaps-pane { border-right: none; border-bottom: 1px solid #1a1a1a; max-height: 350px; }
    .sources-layout { grid-template-columns: 1fr; }
    .sources-sidebar { border-right: none; border-bottom: 1px solid #1a1a1a; max-height: 200px; }
    .system-layout { grid-template-columns: 1fr; }
    .system-col { border-right: none; border-bottom: 1px solid #1a1a1a; max-height: 400px; }
}

@media (max-width: 768px) {
    /* Top bar: stack vertically */
    .top-bar { flex-wrap: wrap; gap: 6px; padding: 8px 10px; }
    .logo { font-size: 16px; letter-spacing: 2px; }
    .logo-sub { font-size: 10px; letter-spacing: 1px; }

    /* Primary tabs: scroll horizontally */
    .primary-tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .primary-tab { padding: 8px 12px; font-size: 10px; letter-spacing: 1px; white-space: nowrap; flex-shrink: 0; }

    /* Tab content: fill remaining height, allow scrolling */
    .tab-content { height: auto; min-height: 0; flex: 1; overflow-y: auto; }
    .tab-content.active { flex-direction: column; }

    /* Stories toolbar: wrap category tabs */
    .stories-toolbar { flex-wrap: wrap; gap: 4px; padding: 6px 8px; }
    .stories-toolbar .tabs { flex-wrap: wrap; }

    /* All grid layouts single-column */
    .stories-layout, .filters-layout, .references-layout, .sources-layout, .system-layout {
        grid-template-columns: 1fr;
        overflow-y: auto;
    }
    .stories-sidebar { max-height: 250px; border-top: 1px solid #1a1a1a; }
    .filters-log-pane { border-top: 1px solid #1a1a1a; }
    .references-sites-pane, .references-gaps-pane {
        border-right: none; border-bottom: 1px solid #1a1a1a; max-height: 300px;
    }
    .sources-sidebar { border-right: none; border-bottom: 1px solid #1a1a1a; max-height: 180px; }
    .system-col { border-right: none; border-bottom: 1px solid #1a1a1a; max-height: none; }

    /* Panels: let them size naturally */
    .panel-body { padding: 8px; }
    .panel-header { padding: 6px 8px; }

    /* Source/ref rows: allow wrapping */
    .ref-site-row, .source-row { flex-wrap: wrap; }
    .ref-site-url, .source-url { width: 100%; flex: none; }

    /* Story curation bar: wrap buttons */
    .curation-bar { flex-wrap: wrap; }

    /* Config row inputs */
    .config-label { min-width: 80px; font-size: 9px; }
    .config-input { width: 80px; }
}
</style>
</head>
<body>

<div class="top-bar">
    <div>
        <span class="logo">DINWIRE</span><span class="logo-sub">CONTROL PANEL</span>
    </div>
    <div style="display:flex;gap:8px;align-items:center;">
        <button class="action-btn danger" id="reboot-btn" onclick="triggerReboot()">REBOOT</button>
        <button class="action-btn" id="backfill-btn" onclick="triggerBackfill()">BACKFILL 48H</button>
        <a class="back" href="/">BACK TO DINWIRE</a>
    </div>
</div>

<!-- â”€â”€ PRIMARY TAB BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="primary-tabs" id="primary-tabs">
    <button class="primary-tab active" data-tab="stories">STORIES</button>
    <button class="primary-tab" data-tab="filters">FILTERS <span class="tab-badge" id="tab-badge-filters"></span></button>
    <button class="primary-tab" data-tab="references">REFERENCES <span class="tab-badge" id="tab-badge-references"></span></button>
    <button class="primary-tab" data-tab="sources">SOURCES <span class="tab-badge" id="tab-badge-sources"></span></button>
    <button class="primary-tab" data-tab="system">SYSTEM <span class="tab-badge" id="tab-badge-system"></span></button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB 1: STORIES
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-content active" id="tab-stories">
    <div class="stories-layout">
        <div class="stories-main">
            <div class="stories-toolbar">
                <div class="tabs" id="sort-tabs">
                    <button class="tab active" data-sort="hot">TOP</button>
                    <button class="tab" data-sort="new">TICKER</button>
                </div>
                <span class="separator">|</span>
                <div class="tabs" id="cat-tabs">
                    <button class="tab active" data-cat="all">ALL</button>
                    <button class="tab" data-cat="markets">MARKETS</button>
                    <button class="tab" data-cat="tech">TECH</button>
                    <button class="tab" data-cat="politics">POLITICS</button>
                    <button class="tab" data-cat="world">WORLD</button>
                </div>
                <label class="show-hidden-label"><input type="checkbox" id="show-hidden"> SHOW HIDDEN</label>
            </div>
            <ul class="story-list" id="story-list"></ul>
            <div class="pagination" id="pagination"></div>
        </div>
        <div class="stories-sidebar">
            <div class="panel panel-grow">
                <div class="panel-header">CURATION LOG</div>
                <div class="panel-body" id="curation-log-body">
                    <div id="curation-log-list"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB 2: FILTERS
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-content" id="tab-filters">
    <div class="filters-layout">
        <!-- Left: Patterns -->
        <div class="filters-patterns-pane">
            <div class="panel-header">FILTER PATTERNS</div>
            <div class="panel-body">
                <div id="filters-list"></div>
                <div class="filter-add-form">
                    <input type="text" id="filter-add-name" placeholder="Filter name...">
                    <input type="text" id="filter-add-pattern" placeholder="Regex pattern...">
                    <select id="filter-add-type">
                        <option value="not_news">not_news</option>
                    </select>
                    <div class="filter-add-buttons">
                        <button class="action-btn" onclick="testNewFilter()" style="font-size:9px;padding:3px 8px;">TEST</button>
                        <button class="action-btn" onclick="addFilter()" style="font-size:9px;padding:3px 8px;">ADD</button>
                    </div>
                    <div class="filter-test-results" id="filter-test-results" style="display:none;"></div>
                </div>
            </div>
        </div>
        <!-- Right: Filtered Items Log -->
        <div class="filters-log-pane">
            <div class="panel-header">FILTERED ITEMS LOG</div>
            <div class="panel-body">
                <input type="text" class="filter-search-input" id="filtered-items-search" placeholder="Search headlines..." oninput="debouncedFetchFilteredItems()">
                <div id="filtered-items-list"></div>
            </div>
            <div class="pagination" id="filtered-items-pagination"></div>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB 3: REFERENCES
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-content" id="tab-references">
    <div class="references-layout">
        <!-- Left: Sites -->
        <div class="references-sites-pane">
            <div class="panel-header">REFERENCE SITES</div>
            <div class="panel-body">
                <div id="ref-sites-list"></div>
                <div class="ref-add-form">
                    <input type="text" id="ref-add-name" placeholder="Site name...">
                    <input type="text" id="ref-add-url" placeholder="URL...">
                    <select id="ref-add-parser">
                        <option value="techmeme">techmeme</option>
                        <option value="drudge">drudge</option>
                        <option value="apnews">apnews</option>
                        <option value="googlenews">googlenews</option>
                    </select>
                    <input type="number" id="ref-add-max" placeholder="Max headlines" value="20" min="1" max="100">
                    <div class="ref-add-buttons">
                        <button class="action-btn" onclick="addRefSite()" style="font-size:9px;padding:3px 8px;">ADD SITE</button>
                    </div>
                </div>
                <div class="ref-check-bar">
                    <button class="action-btn" id="ref-check-btn" onclick="runRefCheck()" style="font-size:9px;padding:3px 8px;">RUN CHECK NOW</button>
                    <span class="ref-check-status" id="ref-check-status"></span>
                </div>
            </div>
        </div>
        <!-- Center: Coverage Gaps -->
        <div class="references-gaps-pane">
            <div class="panel-header">COVERAGE GAPS <span id="ref-gaps-count" style="color:#888;font-weight:400;"></span></div>
            <div class="panel-body">
                <div id="ref-gaps-list"></div>
            </div>
            <div class="pagination" id="ref-gaps-pagination"></div>
        </div>
        <!-- Right: Full Check Log -->
        <div class="references-log-pane">
            <div class="panel-header">CHECK LOG</div>
            <div class="panel-body">
                <div id="ref-log-list"></div>
            </div>
            <div class="pagination" id="ref-log-pagination"></div>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB 4: SOURCES
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-content" id="tab-sources">
    <div class="sources-layout">
        <!-- Left: Category Sidebar -->
        <div class="sources-sidebar">
            <div class="panel-header">CATEGORIES</div>
            <div class="panel-body" id="sources-cat-list" style="flex:1;overflow-y:auto;"></div>
            <div class="cat-add-form">
                <input type="text" id="sources-cat-add-name" placeholder="New category...">
                <button class="action-btn" onclick="addCategory()" style="font-size:9px;padding:3px 8px;">ADD</button>
            </div>
        </div>
        <!-- Right: Source List -->
        <div class="sources-main">
            <div class="panel-header">FEED SOURCES <span id="sources-count" style="color:#888;font-weight:400;"></span></div>
            <div class="panel-body" id="sources-list" style="flex:1;overflow-y:auto;"></div>
            <div class="source-add-form" style="padding:8px 12px;">
                <input type="text" id="source-add-name" placeholder="Source name...">
                <input type="text" id="source-add-url" placeholder="Feed URL...">
                <select id="source-add-category"></select>
                <div class="source-add-buttons">
                    <button class="action-btn" onclick="addSource()" style="font-size:9px;padding:3px 8px;">ADD SOURCE</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB 5: SYSTEM
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-content" id="tab-system">
    <div class="system-layout">
        <!-- Col 1: Processes + Stats -->
        <div class="system-col">
            <div class="panel">
                <div class="panel-header">PROCESSES</div>
                <div class="panel-body">
                    <div class="job-card" id="job-rss">
                        <div class="job-name">RSS</div>
                        <div class="job-field">next: <span id="rss-next">--</span></div>
                        <div class="job-countdown" id="rss-countdown">--:--</div>
                    </div>
                    <div class="job-card" id="job-search">
                        <div class="job-name">SEARCH</div>
                        <div class="job-field">next: <span id="search-next">--</span></div>
                        <div class="job-countdown" id="search-countdown">--:--</div>
                    </div>
                    <div class="job-card" id="job-rewrite">
                        <div class="job-name">REWRITE</div>
                        <div class="job-field">next: <span id="rewrite-next">--</span></div>
                        <div class="job-countdown" id="rewrite-countdown">--:--</div>
                    </div>
                    <div class="job-card" id="job-cleanup">
                        <div class="job-name">CLEANUP</div>
                        <div class="job-field">next: <span id="cleanup-next">--</span></div>
                        <div class="job-countdown" id="cleanup-countdown">--:--</div>
                    </div>
                    <div class="job-card" id="job-reference_check">
                        <div class="job-name">REF CHECK</div>
                        <div class="job-field">next: <span id="reference_check-next">--</span></div>
                        <div class="job-countdown" id="reference_check-countdown">--:--</div>
                    </div>
                    <div class="job-card" style="cursor:pointer;border-color:#ffb000;" onclick="doRecluster()">
                        <div class="job-name" style="color:#ffb000;">RECLUSTER</div>
                        <div class="job-field" id="recluster-status">click to rebuild</div>
                    </div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-header">STATS</div>
                <div class="panel-body">
                    <div class="stat-row"><span class="stat-label">clusters</span><span class="stat-value green" id="stat-clusters">--</span></div>
                    <div class="stat-row"><span class="stat-label">raw items</span><span class="stat-value" id="stat-raw">--</span></div>
                    <div class="stat-row"><span class="stat-label">pending rewrites</span><span class="stat-value amber" id="stat-pending">--</span></div>
                    <div class="stat-row"><span class="stat-label">active filters</span><span class="stat-value" id="stat-filters">--</span></div>
                    <div class="stat-row"><span class="stat-label">filtered (24h)</span><span class="stat-value amber" id="stat-filtered-24h">--</span></div>
                    <div class="stat-row"><span class="stat-label">ref sites</span><span class="stat-value" id="stat-ref-sites">--</span></div>
                    <div class="stat-row"><span class="stat-label">ref gaps (24h)</span><span class="stat-value amber" id="stat-ref-gaps">--</span></div>
                    <div class="stat-row"><span class="stat-label">last ref check</span><span class="stat-value" id="stat-last-ref" style="font-size:9px;">--</span></div>
                </div>
            </div>
        </div>

        <!-- Col 2: Events -->
        <div class="system-col">
            <div class="panel panel-grow">
                <div class="panel-header">
                    <span>EVENTS</span>
                    <div class="filter-bar">
                        <button class="filter-btn active" data-filter="all">ALL</button>
                        <button class="filter-btn" data-filter="ingest">IN</button>
                        <button class="filter-btn" data-filter="cluster">CL</button>
                        <button class="filter-btn" data-filter="rewrite">RW</button>
                        <button class="filter-btn" data-filter="error">ER</button>
                    </div>
                </div>
                <div class="panel-body" id="event-stream-body">
                    <ul class="event-list" id="event-list"></ul>
                </div>
            </div>
        </div>

        <!-- Col 3: Live Config -->
        <div class="system-col">
            <div class="panel panel-grow">
                <div class="panel-header">LIVE CONFIG</div>
                <div class="panel-body">
                    <div class="config-row">
                        <span class="config-label">similarity</span>
                        <input class="config-input" id="cfg-similarity" type="number" step="0.01" min="0" max="1">
                        <button class="config-set" onclick="setConfig('clustering.similarity_threshold', document.getElementById('cfg-similarity').value)">SET</button>
                    </div>
                    <div class="config-row">
                        <span class="config-label">lookback hrs</span>
                        <input class="config-input" id="cfg-lookback" type="number" step="1" min="1">
                        <button class="config-set" onclick="setConfig('clustering.lookback_hours', document.getElementById('cfg-lookback').value)">SET</button>
                    </div>
                    <div class="config-row">
                        <span class="config-label">AI model</span>
                        <input class="config-input" id="cfg-model" type="text" style="width:160px;">
                        <button class="config-set" onclick="setConfig('ai.model', document.getElementById('cfg-model').value)">SET</button>
                    </div>
                    <div class="config-row">
                        <span class="config-label">batch size</span>
                        <input class="config-input" id="cfg-batch" type="number" step="1" min="1">
                        <button class="config-set" onclick="setConfig('ai.batch_size', document.getElementById('cfg-batch').value)">SET</button>
                    </div>
                    <div class="config-row">
                        <span class="config-label">RSS interval</span>
                        <input class="config-input" id="cfg-rss-interval" type="number" step="1" min="1">
                        <button class="config-set" onclick="setConfig('polling.rss_interval_minutes', document.getElementById('cfg-rss-interval').value)">SET</button>
                    </div>
                    <div class="config-row">
                        <span class="config-label">search interval</span>
                        <input class="config-input" id="cfg-search-interval" type="number" step="1" min="1">
                        <button class="config-set" onclick="setConfig('polling.search_interval_minutes', document.getElementById('cfg-search-interval').value)">SET</button>
                    </div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-header">CATEGORIES</div>
                <div class="panel-body">
                    <div id="system-categories-list"></div>
                    <div class="config-row" style="margin-top:8px;">
                        <input class="config-input" id="system-cat-add-name" type="text" placeholder="New category..." style="width:140px;">
                        <button class="config-set" onclick="addCategoryFromSystem()">ADD</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let storiesPage = 0;
const storiesPerPage = 50;
let currentSort = 'hot';
let currentCat = 'all';
let eventFilter = 'all';
let jobNextRuns = {};
let expandedStory = null;

// â”€â”€ Primary Tab Switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let activeTab = 'stories';

document.querySelectorAll('#primary-tabs .primary-tab').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('#primary-tabs .primary-tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeTab = btn.dataset.tab;
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        document.getElementById(`tab-${activeTab}`).classList.add('active');

        // Lazy-load data when switching tabs
        if (activeTab === 'filters') {
            fetchFilters();
            fetchFilteredItems();
        } else if (activeTab === 'references') {
            fetchRefSites();
            fetchRefGaps();
            fetchRefLog();
        } else if (activeTab === 'sources') {
            fetchSources();
            fetchCategories();
        } else if (activeTab === 'system') {
            fetchEvents();
            fetchSystemCategories();
        }
    });
});

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) {
    if (!s) return '';
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
}

function trunc(s, n) {
    if (!s) return '';
    return s.length > n ? s.substring(0, n) + '...' : s;
}

function fmtTime(iso) {
    if (!iso) return '--:--';
    return new Date(iso).toLocaleTimeString('en-US', { hour12: false });
}

function fmtCountdown(iso) {
    if (!iso) return '--:--';
    const diff = new Date(iso) - new Date();
    if (diff <= 0) return 'NOW';
    const m = Math.floor(diff / 60000);
    const s = Math.floor((diff % 60000) / 1000);
    return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
}

function timeAgo(iso) {
    if (!iso) return '';
    const diff = Date.now() - new Date(iso).getTime();
    const mins = Math.floor(diff / 60000);
    if (mins < 1) return 'just now';
    if (mins < 60) return `${mins}m ago`;
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return `${hrs}h ago`;
    return `${Math.floor(hrs / 24)}d ago`;
}

function eventTag(type) {
    if (type.startsWith('ingest')) return 'ingest';
    if (type.startsWith('cluster')) return 'cluster';
    if (type === 'rewrite') return 'rewrite';
    if (type === 'error') return 'error';
    return 'ingest';
}

function eventMsg(ev) {
    switch (ev.type) {
        case 'ingest_start': return `${ev.job.toUpperCase()} started`;
        case 'ingest_done': return `${ev.job.toUpperCase()} done: ${ev.items} items`;
        case 'cluster_hit': return `merged "${trunc(ev.headline, 40)}"`;
        case 'cluster_new': return `new: "${trunc(ev.headline, 40)}"`;
        case 'rewrite': return `"${trunc(ev.after, 50)}"`;
        case 'error': return `[${ev.source}] ${ev.message}`;
        default: return JSON.stringify(ev);
    }
}

// â”€â”€ Wire energy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TIER1_SOURCES = new Set([
    'reuters', 'ap', 'associated press', 'bloomberg', 'bbc', 'nyt', 'new york times',
    'the new york times', 'wsj', 'wall street journal', 'the wall street journal',
    'cnn', 'financial times', 'ft', 'the washington post', 'washington post',
    'the guardian', 'npr', 'al jazeera', 'axios', 'politico', 'the economist',
    'techcrunch', 'the verge', 'ars technica', 'wired', 'cnbc', 'abc news',
    'cbs news', 'nbc news', 'pbs', 'the atlantic', 'time', 'fortune',
]);

function wireEnergy(s) {
    try {
        const allNames = [s.source, ...(s.other_sources || []).map(o => o.name)].filter(Boolean);
        const uniqueHeadlines = new Set((s.items || []).map(i => i.headline)).size || 1;
        const coverage = Math.min(uniqueHeadlines, 15) / 15;
        const t1 = allNames.filter(n => n && TIER1_SOURCES.has(n.toLowerCase())).length;
        const quality = Math.min(t1, 5) / 5;
        const ts = s.published_at || s.first_seen;
        const hoursOld = ts ? Math.max(0, (Date.now() - new Date(ts).getTime()) / 3600000) : 48;
        const recency = Math.max(0, 1 - hoursOld / 72);
        const raw = (coverage * 0.55 + quality * 0.45) * (0.15 + recency * 0.85);
        return Math.min(1, Math.max(0, raw));
    } catch(e) { return 0; }
}

// â”€â”€ API calls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function apiPost(endpoint, body) {
    const resp = await fetch(`/api/river/${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
    });
    return resp.json();
}

// â”€â”€ Fetch Stories â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchStories() {
    const showHidden = document.getElementById('show-hidden').checked;

    try {
        const params = new URLSearchParams({
            category: currentCat,
            sort: currentSort,
            show_hidden: showHidden,
            limit: storiesPerPage,
            offset: storiesPage * storiesPerPage,
        });
        const resp = await fetch(`/api/river/stories?${params}`);
        const data = await resp.json();
        renderStories(data.stories, data.total);
    } catch (e) {
        console.error('Stories fetch error:', e);
    }
}

function renderStories(stories, total) {
    const list = document.getElementById('story-list');
    list.innerHTML = stories.map(s => {
        const classes = ['story-row'];
        if (s.breaking) classes.push('breaking');
        else if (s.pinned) classes.push('pinned');
        if (s.hidden) classes.push('hidden');
        if (s.locked) classes.push('locked');
        if (s.boost > 0) classes.push('boosted');
        if (s.boost < 0) classes.push('demoted');

        // Other sources line (mirroring homepage "also: X Â· Y Â· Z")
        const allOthers = s.other_sources || [];
        const shownOthers = allOthers.slice(0, 3).map(o =>
            `<a href="${esc(o.url)}" target="_blank" rel="noopener">${esc(o.name)}</a>`
        ).join(' &middot; ');
        const moreCount = (s.items && s.items.length) || 0;
        const moreBtn = moreCount > 0 ? ` <button class="cur-btn" onclick="toggleExpand('${esc(s.id)}')" style="font-size:8px;padding:1px 4px;">+${moreCount} more</button>` : '';
        const alsoLine = shownOthers ? `<div class="story-also">also: ${shownOthers}${moreBtn}</div>` : '';

        const countDisplay = s.source_count > 1 ? `<span class="story-count">+${s.source_count}</span>` : '';
        const displayHeadline = (currentSort === 'new' && s.original_headline) ? s.original_headline : s.headline;

        // Curation icon indicators
        const icons = [];
        if (s.breaking) icons.push('<span title="BREAKING" style="color:#e04040;font-size:10px;font-weight:700;">BREAKING</span>');
        if (s.note) icons.push('<span title="Has note" style="color:#c06ece;">&#9998;</span>');

        // Expanded view: items with swap-primary buttons
        const itemsHtml = s.items.map(item => `
            <div class="item-row">
                <label>
                    <input type="checkbox" class="item-check" value="${esc(item.id)}" data-cluster="${esc(s.id)}">
                    <span class="item-source">${esc(item.source)}</span>
                    ${esc(trunc(item.headline, 60))}
                </label>
                <button class="swap-btn" onclick="swapPrimary('${esc(s.id)}', '${esc(item.url)}')" title="Make primary link">SWAP</button>
            </div>
        `).join('');

        const noteDisplay = s.note ? `<div class="note-display">${esc(s.note)}</div>` : '';

        const energy = wireEnergy(s);

        return `
        <li class="${classes.join(' ')}" data-id="${esc(s.id)}">
            <div class="wire-ball" style="--energy:${energy.toFixed(3)}"></div>
            <div class="story-row-body">
                <div class="story-main">
                    <span class="story-headline" onclick="editHeadline(this, '${esc(s.id)}')" title="Click to edit">${esc(displayHeadline)}</span>
                    <span class="story-meta">
                        <span class="story-source">via ${esc(s.source)}</span>${countDisplay}
                        <span class="story-category" onclick="editCategory(this, '${esc(s.id)}')" title="Click to change">${esc((s.category || '').toUpperCase())}</span>
                        <span class="story-time">${timeAgo(s.published_at)}</span>
                        ${icons.join(' ')}
                    </span>
                </div>
                ${alsoLine}
                <div class="curation-bar">
                    <button class="cur-btn ${s.pinned ? 'active' : ''}" onclick="togglePin('${esc(s.id)}', ${s.pinned ? 0 : 1})" title="Pin">${s.pinned ? '&#9733; UNPIN' : '&#9734; PIN'}</button>
                    <button class="cur-btn ${s.hidden ? 'active' : ''}" onclick="toggleHide('${esc(s.id)}', ${s.hidden ? 0 : 1})" title="Hide">${s.hidden ? '&#9673; UNHIDE' : '&#9675; HIDE'}</button>
                    <button class="cur-btn ${s.locked ? 'active' : ''}" onclick="toggleLock('${esc(s.id)}', ${s.locked ? 0 : 1})" title="Lock">${s.locked ? '&#128275; UNLOCK' : '&#128274; LOCK'}</button>
                    <button class="cur-btn ${s.breaking ? 'breaking-active' : ''}" onclick="toggleBreaking('${esc(s.id)}', ${s.breaking ? 0 : 1})" title="Breaking">&#9889; ${s.breaking ? 'UNBREAK' : 'BREAKING'}</button>
                    <button class="cur-btn kill-btn" onclick="notNews('${esc(s.id)}')" title="Not news â€” remove from feed">&#10005; NOT NEWS</button>
                    <button class="cur-btn ${s.boost > 0 ? 'boost-active' : ''}" onclick="setBoost('${esc(s.id)}', ${s.boost > 0 ? 0 : 1})" title="Boost up">&#9650; BOOST</button>
                    <button class="cur-btn ${s.boost < 0 ? 'demote-active' : ''}" onclick="setBoost('${esc(s.id)}', ${s.boost < 0 ? 0 : -1})" title="Demote">&#9660; DEMOTE</button>
                    <button class="cur-btn" onclick="showFlagMenu(this, '${esc(s.id)}')" title="Flag issue">&#9873; FLAG</button>
                    <button class="cur-btn ${s.note ? 'note-active' : ''}" onclick="promptNote('${esc(s.id)}', this)" title="Editorial note">&#9998; NOTE</button>
                    <button class="cur-btn" onclick="promptExpiry('${esc(s.id)}')" title="Override expiry">&#9201; EXPIRY</button>
                    <button class="cur-btn" onclick="toggleExpand('${esc(s.id)}')" title="Expand items">&#9776; EXPAND</button>
                </div>
                <div class="story-expanded" id="expand-${s.id}">
                    ${noteDisplay}
                    ${itemsHtml}
                    <div class="split-bar">
                        <button class="cur-btn" onclick="splitSelected('${esc(s.id)}')">SPLIT CHECKED</button>
                    </div>
                    <div class="merge-bar">
                        <input type="text" placeholder="Target cluster ID to merge into..." id="merge-target-${s.id}">
                        <button class="cur-btn" onclick="mergeInto('${esc(s.id)}')">MERGE INTO</button>
                    </div>
                </div>
            </div>
        </li>`;
    }).join('');

    // Pagination
    const totalPages = Math.ceil(total / storiesPerPage);
    const pag = document.getElementById('pagination');
    pag.innerHTML = `
        <button ${storiesPage === 0 ? 'disabled' : ''} onclick="storiesPage--; fetchStories();">PREV</button>
        <span>${storiesPage + 1} / ${totalPages || 1} (${total} stories)</span>
        <button ${storiesPage >= totalPages - 1 ? 'disabled' : ''} onclick="storiesPage++; fetchStories();">NEXT</button>
    `;
}

// â”€â”€ Curation Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function editHeadline(el, clusterId) {
    const current = el.textContent;
    const input = document.createElement('input');
    input.className = 'inline-edit';
    input.value = current;
    el.textContent = '';
    el.appendChild(input);
    input.focus();
    input.select();

    async function save() {
        const val = input.value.trim();
        if (val && val !== current) {
            await apiPost('edit-headline', { cluster_id: clusterId, headline: val });
            fetchCurationLog();
        }
        el.textContent = val || current;
    }

    input.addEventListener('blur', save);
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
        if (e.key === 'Escape') { el.textContent = current; }
    });
}

function editCategory(el, clusterId) {
    const cats = ['tech', 'markets', 'politics', 'world', 'general'];
    const dropdown = document.createElement('ul');
    dropdown.className = 'cat-dropdown';
    const rect = el.getBoundingClientRect();
    dropdown.style.left = rect.left + 'px';
    dropdown.style.top = rect.bottom + 'px';
    dropdown.style.position = 'fixed';

    cats.forEach(cat => {
        const li = document.createElement('li');
        li.textContent = cat.toUpperCase();
        li.addEventListener('click', async () => {
            await apiPost('edit-category', { cluster_id: clusterId, category: cat });
            el.textContent = cat.toUpperCase();
            document.body.removeChild(dropdown);
            fetchCurationLog();
            fetchStories();
        });
        dropdown.appendChild(li);
    });

    document.body.appendChild(dropdown);
    setTimeout(() => {
        document.addEventListener('click', function close(e) {
            if (!dropdown.contains(e.target)) {
                if (dropdown.parentNode) document.body.removeChild(dropdown);
                document.removeEventListener('click', close);
            }
        });
    }, 10);
}

async function togglePin(clusterId, pinned) {
    await apiPost('pin', { cluster_id: clusterId, pinned });
    fetchStories();
    fetchCurationLog();
}

async function toggleHide(clusterId, hidden) {
    await apiPost('hide', { cluster_id: clusterId, hidden });
    fetchStories();
    fetchCurationLog();
}

async function toggleLock(clusterId, locked) {
    await apiPost('lock', { cluster_id: clusterId, locked });
    fetchStories();
    fetchCurationLog();
}

async function toggleBreaking(clusterId, breaking) {
    await apiPost('breaking', { cluster_id: clusterId, breaking });
    fetchStories();
    fetchCurationLog();
}

async function notNews(clusterId) {
    if (!confirm('Mark as not news? It will be removed from the feed.')) return;
    await apiPost('not-news', { cluster_id: clusterId });
    fetchStories();
    fetchCurationLog();
}

async function setBoost(clusterId, boost) {
    await apiPost('boost', { cluster_id: clusterId, boost });
    fetchStories();
    fetchCurationLog();
}

async function swapPrimary(clusterId, sourceUrl) {
    await apiPost('swap-primary', { cluster_id: clusterId, source_url: sourceUrl });
    fetchStories();
    fetchCurationLog();
}

function showFlagMenu(el, clusterId) {
    const flags = ['miscategorized', 'bad_headline', 'bad_merge', 'duplicate', 'stale'];
    const dropdown = document.createElement('ul');
    dropdown.className = 'flag-dropdown';
    const rect = el.getBoundingClientRect();
    dropdown.style.left = rect.left + 'px';
    dropdown.style.top = rect.bottom + 'px';

    flags.forEach(flag => {
        const li = document.createElement('li');
        li.textContent = flag.replace('_', ' ').toUpperCase();
        li.addEventListener('click', async () => {
            await apiPost('flag', { cluster_id: clusterId, flag_type: flag });
            if (dropdown.parentNode) document.body.removeChild(dropdown);
            fetchCurationLog();
        });
        dropdown.appendChild(li);
    });

    document.body.appendChild(dropdown);
    setTimeout(() => {
        document.addEventListener('click', function close(e) {
            if (!dropdown.contains(e.target) && e.target !== el) {
                if (dropdown.parentNode) document.body.removeChild(dropdown);
                document.removeEventListener('click', close);
            }
        });
    }, 10);
}

async function promptNote(clusterId, el) {
    const note = prompt('Editorial note (leave empty to clear):');
    if (note === null) return;
    await apiPost('note', { cluster_id: clusterId, note });
    fetchStories();
    fetchCurationLog();
}

async function promptExpiry(clusterId) {
    const input = prompt('Set expiry (ISO datetime, e.g. 2025-12-31T23:59:59Z):');
    if (!input) return;
    await apiPost('set-expiry', { cluster_id: clusterId, expires_at: input });
    fetchStories();
    fetchCurationLog();
}

function toggleExpand(clusterId) {
    const el = document.getElementById(`expand-${clusterId}`);
    if (el) el.classList.toggle('open');
}

async function splitSelected(clusterId) {
    const checks = document.querySelectorAll(`#expand-${clusterId} .item-check:checked`);
    const itemIds = Array.from(checks).map(c => c.value);
    if (itemIds.length === 0) { alert('Select items to split'); return; }
    const result = await apiPost('split', { cluster_id: clusterId, item_ids: itemIds });
    if (result.status === 'ok') {
        fetchStories();
        fetchCurationLog();
    } else {
        alert(result.error || 'Split failed');
    }
}

async function mergeInto(sourceId) {
    const targetInput = document.getElementById(`merge-target-${sourceId}`);
    const targetId = targetInput.value.trim();
    if (!targetId) { alert('Enter target cluster ID'); return; }
    const result = await apiPost('merge', { source_cluster_id: sourceId, target_cluster_id: targetId });
    if (result.status === 'ok') {
        fetchStories();
        fetchCurationLog();
    } else {
        alert(result.error || 'Merge failed');
    }
}

// â”€â”€ Live Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function setConfig(key, value) {
    const result = await apiPost('config', { key, value });
    if (result.status === 'ok') {
        fetchStatus();
        fetchCurationLog();
    } else {
        alert(result.error || 'Config update failed');
    }
}

// â”€â”€ Curation Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchCurationLog() {
    try {
        const resp = await fetch('/api/river/curation-log?limit=50');
        const data = await resp.json();
        const container = document.getElementById('curation-log-list');
        container.innerHTML = data.entries.map(e => {
            const d = e.detail || {};
            const hl = d.headline ? trunc(d.headline, 50) : null;
            const q = s => `"${s}"`;
            let sentence = '';

            if (e.action === 'edit_headline') {
                sentence = hl ? `The headline ${q(trunc(d.before, 40))} was rewritten to ${q(trunc(d.after, 40))}` : `A headline was rewritten to ${q(trunc(d.after, 40))}`;
            } else if (e.action === 'edit_category') {
                sentence = hl ? `The item ${q(hl)} was recategorized from ${d.before} to ${d.after}` : `An item was recategorized from ${d.before} to ${d.after}`;
            } else if (e.action === 'config_change') {
                sentence = `Config ${d.key} was changed from ${d.before} to ${d.after}`;
            } else if (e.action === 'merge') {
                sentence = hl ? `The item ${q(hl)} was merged into another cluster` : `A cluster was merged into another cluster`;
            } else if (e.action === 'split') {
                sentence = hl ? `${d.new_cluster_size} items were split from ${q(hl)}` : `${d.new_cluster_size} items were split into a new cluster`;
            } else if (e.action === 'swap_primary') {
                sentence = hl ? `The item ${q(hl)} had its primary source swapped from ${d.old_source} to ${d.new_source}` : `Primary source was swapped from ${d.old_source} to ${d.new_source}`;
            } else if (e.action.startsWith('flag_')) {
                const flagName = e.action.replace('flag_', '').replace(/_/g, ' ');
                sentence = hl ? `The item ${q(hl)} was flagged as ${flagName}` : `An item was flagged as ${flagName}`;
                if (d.detail) sentence += `: ${d.detail}`;
            } else if (e.action === 'breaking_on') {
                sentence = hl ? `The item ${q(hl)} was marked as BREAKING` : `An item was marked as BREAKING`;
            } else if (e.action === 'breaking_off') {
                sentence = hl ? `The item ${q(hl)} had BREAKING removed` : `An item had BREAKING removed`;
            } else if (e.action === 'kill' || e.action === 'not_news') {
                sentence = hl ? `The item ${q(hl)} was removed as not news` : `An item was removed as not news`;
            } else if (e.action === 'pin') {
                sentence = hl ? `The item ${q(hl)} was pinned` : `An item was pinned`;
            } else if (e.action === 'unpin') {
                sentence = hl ? `The item ${q(hl)} was unpinned` : `An item was unpinned`;
            } else if (e.action === 'hide') {
                sentence = hl ? `The item ${q(hl)} was hidden` : `An item was hidden`;
            } else if (e.action === 'unhide') {
                sentence = hl ? `The item ${q(hl)} was unhidden` : `An item was unhidden`;
            } else if (e.action === 'lock') {
                sentence = hl ? `The item ${q(hl)} was locked` : `An item was locked`;
            } else if (e.action === 'unlock') {
                sentence = hl ? `The item ${q(hl)} was unlocked` : `An item was unlocked`;
            } else if (e.action === 'boost') {
                sentence = hl ? `The item ${q(hl)} was boosted` : `An item was boosted`;
            } else if (e.action === 'demote') {
                sentence = hl ? `The item ${q(hl)} was demoted` : `An item was demoted`;
            } else if (e.action === 'unboost') {
                sentence = hl ? `The item ${q(hl)} had its boost cleared` : `An item had its boost cleared`;
            } else if (e.action === 'note') {
                sentence = d.note
                    ? (hl ? `A note was added to ${q(hl)}: ${q(trunc(d.note, 40))}` : `A note was added: ${q(trunc(d.note, 40))}`)
                    : (hl ? `The note on ${q(hl)} was cleared` : `A note was cleared`);
            } else if (e.action === 'set_expiry') {
                sentence = hl ? `The expiry on ${q(hl)} was set to ${d.new_expires_at}` : `An expiry was set to ${d.new_expires_at}`;
            } else {
                sentence = hl ? `The item ${q(hl)} had action: ${e.action}` : `Action: ${e.action}`;
            }

            const actionClass = e.action.replace(/ /g, '_');
            return `<div class="log-entry">
                <span class="log-action ${actionClass}">${e.action.replace(/_/g, ' ')}</span>
                <span class="log-time">${fmtTime(e.created_at)}</span>
                <div class="log-detail">${sentence}</div>
            </div>`;
        }).join('');
    } catch (e) {
        console.error('Curation log fetch error:', e);
    }
}

// â”€â”€ Fetch Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchStatus() {
    try {
        const resp = await fetch('/api/river/status');
        const data = await resp.json();

        for (const id of ['rss', 'search', 'rewrite', 'cleanup', 'reference_check']) {
            const job = data.jobs[id];
            if (job) {
                jobNextRuns[id] = job.next_run;
                const nextEl = document.getElementById(`${id}-next`);
                if (nextEl) nextEl.textContent = fmtTime(job.next_run);
            }
        }

        document.getElementById('stat-clusters').textContent = data.db.clusters;
        document.getElementById('stat-raw').textContent = data.db.raw_items;
        document.getElementById('stat-pending').textContent = data.db.pending_rewrites;
        document.getElementById('stat-filters').textContent = data.db.active_filters;
        document.getElementById('stat-filtered-24h').textContent = data.db.filtered_24h;
        document.getElementById('stat-ref-sites').textContent = data.db.reference_sites != null ? data.db.reference_sites : '--';
        document.getElementById('stat-ref-gaps').textContent = data.db.reference_gaps_24h != null ? data.db.reference_gaps_24h : '--';
        document.getElementById('stat-last-ref').textContent = data.db.last_reference_check ? timeAgo(data.db.last_reference_check) : 'never';

        // Update references tab badge
        document.getElementById('tab-badge-references').textContent = data.db.reference_sites != null ? `(${data.db.reference_sites})` : '';

        // Update tab badges
        document.getElementById('tab-badge-filters').textContent = data.db.active_filters != null ? `(${data.db.active_filters})` : '';
        document.getElementById('tab-badge-system').textContent = data.db.pending_rewrites > 0 ? `(${data.db.pending_rewrites} pending)` : '';

        // Populate config inputs with current values (only if not focused)
        const fields = {
            'cfg-similarity': data.config.similarity_threshold,
            'cfg-lookback': data.config.lookback_hours,
            'cfg-model': data.config.model,
            'cfg-batch': data.config.batch_size,
            'cfg-rss-interval': data.config.rss_interval_minutes,
            'cfg-search-interval': data.config.search_interval_minutes,
        };
        for (const [id, val] of Object.entries(fields)) {
            const el = document.getElementById(id);
            if (el && document.activeElement !== el) el.value = val;
        }
    } catch (e) {
        console.error('Status fetch error:', e);
    }
}

// â”€â”€ Fetch Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchEvents() {
    try {
        const resp = await fetch('/api/river/events?limit=100');
        const data = await resp.json();
        let events = data.events;
        if (eventFilter !== 'all') {
            events = events.filter(ev => eventTag(ev.type) === eventFilter);
        }

        const list = document.getElementById('event-list');
        list.innerHTML = events.slice(0, 50).map(ev => {
            const tag = eventTag(ev.type);
            return `<li class="event-item">
                <span class="ev-time">${fmtTime(ev.ts)}</span>
                <span class="ev-tag ${tag}">${ev.type.replace('_', ' ').toUpperCase()}</span>
                <div class="ev-msg">${esc(eventMsg(ev))}</div>
            </li>`;
        }).join('');
    } catch (e) {
        console.error('Events fetch error:', e);
    }
}

// â”€â”€ Recluster â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doRecluster() {
    const status = document.getElementById('recluster-status');
    status.textContent = 'rebuilding...';
    try {
        const r = await fetch('/api/recluster', { method: 'POST' });
        const d = await r.json();
        status.textContent = `${d.items} items -> ${d.clusters} clusters`;
        fetchStories();
        fetchStatus();
    } catch (e) {
        status.textContent = 'error: ' + e.message;
    }
}

// â”€â”€ Backfill / Reboot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function triggerBackfill() {
    const btn = document.getElementById('backfill-btn');
    btn.disabled = true;
    btn.textContent = 'BACKFILLING...';
    try {
        await fetch('/api/river/backfill', { method: 'POST' });
        const poll = setInterval(async () => {
            const r = await fetch('/api/river/events?limit=10');
            const d = await r.json();
            const done = d.events.find(e => e.type === 'ingest_done' && e.job === 'backfill');
            if (done) {
                clearInterval(poll);
                btn.disabled = false;
                btn.textContent = 'BACKFILL 48H';
                fetchStories();
                fetchStatus();
            }
        }, 3000);
        setTimeout(() => { clearInterval(poll); btn.disabled = false; btn.textContent = 'BACKFILL 48H'; }, 300000);
    } catch (e) {
        btn.disabled = false;
        btn.textContent = 'BACKFILL 48H';
    }
}

async function triggerReboot() {
    if (!confirm('Wipe database and reboot? Curation overrides will be cleared but the curation log is preserved.')) return;
    const btn = document.getElementById('reboot-btn');
    btn.disabled = true;
    btn.textContent = 'REBOOTING...';
    try {
        const resp = await fetch('/api/river/reboot', { method: 'POST' });
        const data = await resp.json();
        if (data.status === 'already_booting') {
            btn.textContent = 'ALREADY BOOTING';
            setTimeout(() => { btn.textContent = 'REBOOT'; btn.disabled = false; }, 3000);
            return;
        }
        const poll = setInterval(async () => {
            try {
                const r = await fetch('/api/boot-status');
                const s = await r.json();
                const pct = Math.round((((s.reference_progress || 0) + s.polling_progress + s.clustering_progress + s.rewriting_progress) / 4) * 100);
                btn.textContent = `BOOTING ${pct}%`;
                fetchStatus();
                if (s.phase === 'ready') {
                    clearInterval(poll);
                    btn.disabled = false;
                    btn.textContent = 'REBOOT';
                    fetchStories();
                    fetchStatus();
                    fetchEvents();
                }
            } catch (_) {}
        }, 2000);
    } catch (e) {
        btn.disabled = false;
        btn.textContent = 'REBOOT';
    }
}

// â”€â”€ Tab controls (story sort/category) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('#sort-tabs .tab').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('#sort-tabs .tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentSort = btn.dataset.sort;
        storiesPage = 0;
        fetchStories();
    });
});

document.querySelectorAll('#cat-tabs .tab').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('#cat-tabs .tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentCat = btn.dataset.cat;
        storiesPage = 0;
        fetchStories();
    });
});

// â”€â”€ Event filter buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        eventFilter = btn.dataset.filter;
        fetchEvents();
    });
});

// â”€â”€ Show hidden toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('show-hidden').addEventListener('change', () => { storiesPage = 0; fetchStories(); });

// â”€â”€ Countdown ticker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateCountdowns() {
    for (const id of ['rss', 'search', 'rewrite', 'cleanup', 'reference_check']) {
        const el = document.getElementById(`${id}-countdown`);
        if (el) el.textContent = fmtCountdown(jobNextRuns[id]);
    }
}

// â”€â”€ Filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let filteredItemsPage = 0;
const filteredItemsPerPage = 50;

async function fetchFilters() {
    try {
        const resp = await fetch('/api/river/filters');
        const data = await resp.json();
        renderFilters(data.filters);
    } catch (e) {
        console.error('Filters fetch error:', e);
    }
}

function renderFilters(filters) {
    const container = document.getElementById('filters-list');
    container.innerHTML = filters.map(f => {
        const onOff = f.enabled ? 'on' : 'off';
        const disabledClass = f.enabled ? '' : ' disabled';
        return `<div class="filter-row${disabledClass}">
            <span class="filter-type-badge">${esc(f.filter_type)}</span>
            <span class="filter-name" title="${esc(f.pattern)}">${esc(f.name)}</span>
            <button class="filter-toggle ${onOff}" onclick="toggleFilter(${f.id}, ${f.enabled ? 0 : 1})">${onOff.toUpperCase()}</button>
            <button class="filter-del" onclick="deleteFilter(${f.id})" title="Delete filter">&times;</button>
        </div>`;
    }).join('');
}

async function toggleFilter(id, enabled) {
    await fetch(`/api/river/filters/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled }),
    });
    fetchFilters();
}

async function deleteFilter(id) {
    if (!confirm('Delete this filter?')) return;
    await fetch(`/api/river/filters/${id}`, { method: 'DELETE' });
    fetchFilters();
}

async function addFilter() {
    const name = document.getElementById('filter-add-name').value.trim();
    const pattern = document.getElementById('filter-add-pattern').value.trim();
    const filter_type = document.getElementById('filter-add-type').value;
    if (!name || !pattern) { alert('Name and pattern required'); return; }

    const resp = await fetch('/api/river/filters', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, pattern, filter_type }),
    });
    const data = await resp.json();
    if (data.error) { alert(data.error); return; }
    document.getElementById('filter-add-name').value = '';
    document.getElementById('filter-add-pattern').value = '';
    document.getElementById('filter-test-results').style.display = 'none';
    fetchFilters();
}

async function testNewFilter() {
    const pattern = document.getElementById('filter-add-pattern').value.trim();
    if (!pattern) { alert('Enter a pattern to test'); return; }

    const resp = await fetch('/api/river/filters/test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pattern }),
    });
    const data = await resp.json();
    if (data.error) { alert(data.error); return; }

    const results = document.getElementById('filter-test-results');
    results.style.display = '';
    if (data.matches.length === 0) {
        results.innerHTML = `<div style="color:#4a9e4a;">No matches in ${data.tested} recent headlines</div>`;
    } else {
        results.innerHTML = `<div style="color:#ffb000;margin-bottom:4px;">${data.matches.length} matches in ${data.tested} headlines:</div>` +
            data.matches.slice(0, 20).map(m => `<div>${esc(m.headline)} <span style="color:#555;">via ${esc(m.source)}</span></div>`).join('');
    }
}

async function fetchFilteredItems() {
    try {
        const search = document.getElementById('filtered-items-search').value.trim();
        const params = new URLSearchParams({
            limit: filteredItemsPerPage,
            offset: filteredItemsPage * filteredItemsPerPage,
        });
        if (search) params.append('search', search);

        const resp = await fetch(`/api/river/filtered-items?${params}`);
        const data = await resp.json();
        renderFilteredItems(data.items, data.total);
    } catch (e) {
        console.error('Filtered items fetch error:', e);
    }
}

function renderFilteredItems(items, total) {
    const container = document.getElementById('filtered-items-list');
    container.innerHTML = items.map(item => `
        <div class="filtered-item-row">
            <div class="filtered-item-headline">${esc(item.headline)}</div>
            <div class="filtered-item-meta">${esc(item.source_name)} &middot; ${timeAgo(item.filtered_at)}</div>
            <div class="filtered-item-filter">caught by: ${esc(item.filter_name)}</div>
        </div>
    `).join('');

    const totalPages = Math.ceil(total / filteredItemsPerPage);
    const pag = document.getElementById('filtered-items-pagination');
    pag.innerHTML = `
        <button ${filteredItemsPage === 0 ? 'disabled' : ''} onclick="filteredItemsPage--; fetchFilteredItems();">PREV</button>
        <span>${filteredItemsPage + 1} / ${totalPages || 1} (${total})</span>
        <button ${filteredItemsPage >= totalPages - 1 ? 'disabled' : ''} onclick="filteredItemsPage++; fetchFilteredItems();">NEXT</button>
    `;
}

let _filteredItemsDebounce = null;
function debouncedFetchFilteredItems() {
    clearTimeout(_filteredItemsDebounce);
    filteredItemsPage = 0;
    _filteredItemsDebounce = setTimeout(fetchFilteredItems, 300);
}

// â”€â”€ References â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let refLogPage = 0;
const refLogPerPage = 100;
let refGapsPage = 0;
const refGapsPerPage = 50;

async function fetchRefSites() {
    try {
        const resp = await fetch('/api/river/references');
        const data = await resp.json();
        renderRefSites(data.sites);
    } catch (e) {
        console.error('Ref sites fetch error:', e);
    }
}

function renderRefSites(sites) {
    const container = document.getElementById('ref-sites-list');
    container.innerHTML = sites.map(s => {
        const onOff = s.enabled ? 'on' : 'off';
        const disabledClass = s.enabled ? '' : ' disabled';
        const stats = s.last_checked
            ? `<span class="found">${s.last_found} found</span> / <span class="gaps">${s.last_gaps} gaps</span> &middot; ${timeAgo(s.last_checked)}`
            : 'not checked yet';
        return `<div class="ref-site-row${disabledClass}">
            <span class="ref-site-name">${esc(s.name)}</span>
            <span class="ref-site-url" title="${esc(s.url)}">${esc(s.url)}</span>
            <span class="ref-site-stats">${stats}</span>
            <button class="ref-site-toggle ${onOff}" onclick="toggleRefSite(${s.id}, ${s.enabled ? 0 : 1})">${onOff.toUpperCase()}</button>
            <button class="ref-site-del" onclick="deleteRefSite(${s.id})" title="Delete site">&times;</button>
        </div>`;
    }).join('');
}

async function toggleRefSite(id, enabled) {
    await fetch(`/api/river/references/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled }),
    });
    fetchRefSites();
}

async function deleteRefSite(id) {
    if (!confirm('Delete this reference site?')) return;
    await fetch(`/api/river/references/${id}`, { method: 'DELETE' });
    fetchRefSites();
    fetchRefLog();
}

async function addRefSite() {
    const name = document.getElementById('ref-add-name').value.trim();
    const url = document.getElementById('ref-add-url').value.trim();
    const parser = document.getElementById('ref-add-parser').value;
    const max_headlines = parseInt(document.getElementById('ref-add-max').value) || 20;
    if (!name || !url) { alert('Name and URL required'); return; }

    const resp = await fetch('/api/river/references', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, url, parser, max_headlines }),
    });
    const data = await resp.json();
    if (data.error) { alert(data.error); return; }
    document.getElementById('ref-add-name').value = '';
    document.getElementById('ref-add-url').value = '';
    document.getElementById('ref-add-max').value = '20';
    fetchRefSites();
}

async function runRefCheck() {
    const btn = document.getElementById('ref-check-btn');
    const status = document.getElementById('ref-check-status');
    btn.disabled = true;
    btn.textContent = 'CHECKING...';
    status.textContent = '';

    try {
        const resp = await fetch('/api/river/references/check', { method: 'POST' });
        const data = await resp.json();
        if (data.status === 'already_running') {
            status.textContent = 'Already running...';
        } else {
            status.textContent = `${data.headlines_found} found, ${data.gaps_found} gaps, ${data.gaps_filled} filled`;
        }
        fetchRefSites();
        fetchRefGaps();
        fetchRefLog();
        fetchStatus();
    } catch (e) {
        status.textContent = 'Error: ' + e.message;
    } finally {
        btn.disabled = false;
        btn.textContent = 'RUN CHECK NOW';
    }
}

async function fetchRefLog() {
    try {
        const params = new URLSearchParams({
            limit: refLogPerPage,
            offset: refLogPage * refLogPerPage,
        });
        const resp = await fetch(`/api/river/references/log?${params}`);
        const data = await resp.json();
        renderRefLog(data.entries, data.total);
    } catch (e) {
        console.error('Ref log fetch error:', e);
    }
}

function renderRefLog(entries, total) {
    const container = document.getElementById('ref-log-list');
    container.innerHTML = entries.map(e => {
        const statusLabel = (e.status || '').replace('_', ' ').toUpperCase();
        const statusClass = e.status || '';
        const clusterLink = e.matched_cluster_id ? ` <span style="color:#555;font-size:8px;">[${e.matched_cluster_id.substring(0, 8)}]</span>` : '';
        const detail = e.detail ? ` <span style="color:#555;">${esc(e.detail)}</span>` : '';
        return `<div class="ref-log-entry">
            <span class="ref-log-status ${statusClass}">${statusLabel}</span>
            <span style="color:#555;font-size:9px;margin-left:4px;">${esc(e.site_name)}</span>
            <span style="color:#555;font-size:9px;margin-left:4px;">${timeAgo(e.checked_at)}</span>
            ${clusterLink}
            <div class="ref-log-headline">${e.headline ? esc(e.headline) : '<em style="color:#555;">Site-level error</em>'}${detail}</div>
        </div>`;
    }).join('');

    const totalPages = Math.ceil(total / refLogPerPage);
    const pag = document.getElementById('ref-log-pagination');
    pag.innerHTML = `
        <button ${refLogPage === 0 ? 'disabled' : ''} onclick="refLogPage--; fetchRefLog();">PREV</button>
        <span>${refLogPage + 1} / ${totalPages || 1} (${total})</span>
        <button ${refLogPage >= totalPages - 1 ? 'disabled' : ''} onclick="refLogPage++; fetchRefLog();">NEXT</button>
    `;
}

// â”€â”€ Reference Gaps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchRefGaps() {
    try {
        const params = new URLSearchParams({
            limit: refGapsPerPage,
            offset: refGapsPage * refGapsPerPage,
            status: 'gap_filled,gap_unfilled',
        });
        const resp = await fetch(`/api/river/references/log?${params}`);
        const data = await resp.json();
        renderRefGaps(data.entries, data.total);
    } catch (e) {
        console.error('Ref gaps fetch error:', e);
    }
}

function renderRefGaps(entries, total) {
    const countEl = document.getElementById('ref-gaps-count');
    countEl.textContent = total > 0 ? `(${total})` : '';

    const container = document.getElementById('ref-gaps-list');
    if (entries.length === 0) {
        container.innerHTML = '<div class="ref-gaps-empty">No coverage gaps detected</div>';
    } else {
        container.innerHTML = entries.map(e => {
            const isFilled = e.status === 'gap_filled';
            const statusBadge = `<span class="ref-log-status ${e.status}">${isFilled ? 'FILLED' : 'UNFILLED'}</span>`;
            const clusterLink = e.matched_cluster_id
                ? `<a href="#" onclick="event.preventDefault(); switchToStory('${e.matched_cluster_id}')" title="${e.matched_cluster_id}">${e.matched_cluster_id.substring(0, 8)}</a>`
                : '';
            const resultLine = isFilled
                ? `<div class="ref-gap-result">matched cluster ${clusterLink}</div>`
                : (e.detail ? `<div class="ref-gap-result">${esc(e.detail)}</div>` : '');
            return `<div class="ref-gap-entry">
                <div class="ref-gap-headline">${esc(e.headline)}</div>
                <div class="ref-gap-meta">
                    ${statusBadge}
                    <span class="ref-gap-site">${esc(e.site_name)}</span>
                    <span>${timeAgo(e.checked_at)}</span>
                </div>
                ${resultLine}
            </div>`;
        }).join('');
    }

    const totalPages = Math.ceil(total / refGapsPerPage);
    const pag = document.getElementById('ref-gaps-pagination');
    pag.innerHTML = total > refGapsPerPage ? `
        <button ${refGapsPage === 0 ? 'disabled' : ''} onclick="refGapsPage--; fetchRefGaps();">PREV</button>
        <span>${refGapsPage + 1} / ${totalPages || 1}</span>
        <button ${refGapsPage >= totalPages - 1 ? 'disabled' : ''} onclick="refGapsPage++; fetchRefGaps();">NEXT</button>
    ` : '';
}

// â”€â”€ Sources â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let sourcesFilter = null; // null = ALL
let categoriesData = [];

async function fetchCategories() {
    try {
        const resp = await fetch('/api/river/categories');
        const data = await resp.json();
        categoriesData = data.categories;
        renderCategorySidebar(categoriesData);
        populateCategoryDropdown(categoriesData);
    } catch (e) {
        console.error('Categories fetch error:', e);
    }
}

function renderCategorySidebar(cats) {
    const container = document.getElementById('sources-cat-list');
    const allActive = sourcesFilter === null ? ' active' : '';
    let html = `<button class="sources-cat-btn${allActive}" onclick="sourcesFilter=null; fetchSources(); renderCategorySidebar(categoriesData);">ALL</button>`;
    for (const cat of cats) {
        const active = sourcesFilter === cat.name ? ' active' : '';
        const disabledStyle = cat.enabled ? '' : ' style="opacity:0.4;"';
        html += `<button class="sources-cat-btn${active}"${disabledStyle} onclick="sourcesFilter='${esc(cat.name)}'; fetchSources(); renderCategorySidebar(categoriesData);">
            ${esc(cat.name.toUpperCase())}
            <span class="sources-cat-badge" id="cat-count-${esc(cat.name)}"></span>
        </button>`;
    }
    container.innerHTML = html;
}

function populateCategoryDropdown(cats) {
    const sel = document.getElementById('source-add-category');
    sel.innerHTML = cats.filter(c => c.enabled).map(c =>
        `<option value="${esc(c.name)}">${esc(c.name)}</option>`
    ).join('');
}

async function fetchSources() {
    try {
        const params = new URLSearchParams();
        if (sourcesFilter) params.set('category', sourcesFilter);
        const resp = await fetch(`/api/river/sources?${params}`);
        const data = await resp.json();
        renderSources(data.sources);
        updateCategoryCounts(data.sources);
    } catch (e) {
        console.error('Sources fetch error:', e);
    }
}

function updateCategoryCounts(sources) {
    // Count sources per category from full list (only when showing ALL)
    if (sourcesFilter === null) {
        const counts = {};
        for (const s of sources) {
            counts[s.category] = (counts[s.category] || 0) + 1;
        }
        for (const cat of categoriesData) {
            const el = document.getElementById(`cat-count-${cat.name}`);
            if (el) el.textContent = counts[cat.name] || 0;
        }
    }
    document.getElementById('sources-count').textContent = `(${sources.length})`;
    document.getElementById('tab-badge-sources').textContent = sources.length || '';
}

function renderSources(sources) {
    const container = document.getElementById('sources-list');
    container.innerHTML = sources.map(s => {
        const onOff = s.enabled ? 'on' : 'off';
        const disabledClass = s.enabled ? '' : ' disabled';
        const scoreTotal = s.score ? s.score.total : '--';
        return `<div class="source-row${disabledClass}">
            <span class="source-name">${esc(s.name)}</span>
            <span class="source-url" title="${esc(s.url)}">${esc(s.url)}</span>
            <span class="source-cat-badge">${esc(s.category.toUpperCase())}</span>
            <span class="source-score">${scoreTotal}</span>
            <button class="source-toggle ${onOff}" onclick="toggleSource(${s.id}, ${s.enabled ? 0 : 1})">${onOff.toUpperCase()}</button>
            <button class="source-del" onclick="deleteSource(${s.id})" title="Delete source">&times;</button>
        </div>`;
    }).join('');
}

async function toggleSource(id, enabled) {
    await fetch(`/api/river/sources/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled }),
    });
    fetchSources();
}

async function deleteSource(id) {
    if (!confirm('Delete this feed source?')) return;
    await fetch(`/api/river/sources/${id}`, { method: 'DELETE' });
    fetchSources();
}

async function addSource() {
    const name = document.getElementById('source-add-name').value.trim();
    const url = document.getElementById('source-add-url').value.trim();
    const category = document.getElementById('source-add-category').value;
    if (!name || !url) { alert('Name and URL required'); return; }

    const resp = await fetch('/api/river/sources', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, url, category }),
    });
    const data = await resp.json();
    if (data.error) { alert(data.error); return; }
    document.getElementById('source-add-name').value = '';
    document.getElementById('source-add-url').value = '';
    fetchSources();
}

async function addCategory() {
    const input = document.getElementById('sources-cat-add-name');
    const name = input.value.trim();
    if (!name) return;

    const resp = await fetch('/api/river/categories', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name }),
    });
    const data = await resp.json();
    if (data.error) { alert(data.error); return; }
    input.value = '';
    fetchCategories();
}

// â”€â”€ System Tab: Category Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchSystemCategories() {
    try {
        const resp = await fetch('/api/river/categories');
        const data = await resp.json();
        renderSystemCategories(data.categories);
    } catch (e) {
        console.error('System categories fetch error:', e);
    }
}

function renderSystemCategories(cats) {
    const container = document.getElementById('system-categories-list');
    container.innerHTML = cats.map(c => {
        const onOff = c.enabled ? 'on' : 'off';
        const disabledStyle = c.enabled ? '' : ' style="opacity:0.4;"';
        return `<div class="cat-mgmt-row"${disabledStyle}>
            <span class="cat-mgmt-name">${esc(c.name)}</span>
            <span class="cat-mgmt-order">#${c.sort_order}</span>
            <button class="source-toggle ${onOff}" onclick="toggleSystemCategory(${c.id}, ${c.enabled ? 0 : 1})">${onOff.toUpperCase()}</button>
            <button class="source-del" onclick="deleteSystemCategory(${c.id})" title="Delete category">&times;</button>
        </div>`;
    }).join('');
}

async function toggleSystemCategory(id, enabled) {
    await fetch(`/api/river/categories/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled }),
    });
    fetchSystemCategories();
}

async function deleteSystemCategory(id) {
    if (!confirm('Delete this category?')) return;
    const resp = await fetch(`/api/river/categories/${id}`, { method: 'DELETE' });
    const data = await resp.json();
    if (data.error) { alert(data.error); return; }
    fetchSystemCategories();
}

async function addCategoryFromSystem() {
    const input = document.getElementById('system-cat-add-name');
    const name = input.value.trim();
    if (!name) return;

    const resp = await fetch('/api/river/categories', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name }),
    });
    const data = await resp.json();
    if (data.error) { alert(data.error); return; }
    input.value = '';
    fetchSystemCategories();
}

function switchToStory(clusterId) {
    // Switch to STORIES tab and try to locate the cluster
    document.querySelectorAll('#primary-tabs .primary-tab').forEach(b => b.classList.remove('active'));
    const storiesBtn = document.querySelector('#primary-tabs .primary-tab[data-tab="stories"]');
    storiesBtn.classList.add('active');
    activeTab = 'stories';
    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
    document.getElementById('tab-stories').classList.add('active');
    fetchStories();
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
fetchStatus();
fetchStories();
fetchCurationLog();

setInterval(fetchStatus, 5000);
setInterval(fetchEvents, 5000);
setInterval(fetchCurationLog, 5000);
setInterval(updateCountdowns, 1000);
</script>
</body>
</html>
